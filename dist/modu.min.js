/* Modu Engine - Built: 2026-01-06T23:21:39.824Z - Commit: bd14907 */
"use strict";var moduNetwork=(()=>{var z=Object.defineProperty,pe=Object.getOwnPropertyDescriptor,we=Object.getOwnPropertyNames,ye=Object.prototype.hasOwnProperty,me=(t,e)=>{for(var c in e)z(t,c,{get:e[c],enumerable:!0})},Se=(t,e,c,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of we(e))!ye.call(t,r)&&r!==c&&z(t,r,{get:()=>e[r],enumerable:!(n=pe(e,r))||n.enumerable});return t},Ie=t=>Se(z({},"__esModule",{value:!0}),t),Z={};me(Z,{connect:()=>V,decodeBinaryMessage:()=>oe,encodeSyncHash:()=>re,getRandomRoom:()=>ie,hashClientId:()=>Y,listRooms:()=>ae,modd:()=>ce,registerClientId:()=>x,unregisterClientId:()=>ne});var F="modd_auth_token",ee="modd_auth_return_url",Ue=class{constructor(){this.appId=null,this.centralServiceUrl="https://nodes.modd.io",this.debug=!1,this.initialized=!1,this.successCallbacks=[],this.errorCallbacks=[],this.stateChangeCallbacks=[],this.currentUser=null,this.pendingAuthCode=null,this.pendingAuthError=null}init(t){if(this.appId=t.appId,this.debug=t.debug||!1,t.centralServiceUrl)this.centralServiceUrl=t.centralServiceUrl;else if(typeof window<"u"){const e=window.location.hostname;(e==="localhost"||e==="127.0.0.1")&&(this.centralServiceUrl="http://localhost:9001")}this.initialized=!0,this.log("Auth module initialized",{appId:this.appId,centralServiceUrl:this.centralServiceUrl}),this.handleAuthCallback(),this.checkExistingSession()}login(t){this.ensureInitialized();const e=t?.provider,c=typeof window<"u"?window.location.href:"/";typeof localStorage<"u"&&localStorage.setItem(ee,c);const n=new URLSearchParams({appId:this.appId,returnUrl:c});let r;e?r=`${this.centralServiceUrl}/auth/${e}?${n}`:r=`${this.centralServiceUrl}/auth/select?${n}`,this.log("Starting login flow",{provider:e,authUrl:r}),typeof window<"u"&&(window.location.href=r)}async logout(){this.ensureInitialized();const t=this.getStoredToken();if(t)try{await fetch(`${this.centralServiceUrl}/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${t}`}})}catch(e){this.log("Logout API call failed (continuing anyway)",e)}this.clearStoredToken(),this.currentUser=null,this.notifyStateChange(null),this.log("User logged out")}async getUser(){if(this.ensureInitialized(),this.currentUser)return this.currentUser;const t=this.getStoredToken();if(!t)return null;try{const e=await fetch(`${this.centralServiceUrl}/auth/whoami`,{headers:{Authorization:`Bearer ${t}`}});if(!e.ok)return this.clearStoredToken(),null;const c=await e.json();return this.currentUser=c.user,this.currentUser}catch(e){return this.log("Failed to get user",e),null}}async deleteAccount(){this.ensureInitialized();const t=this.getStoredToken();if(!t)throw new Error("Not logged in");const e=await fetch(`${this.centralServiceUrl}/auth/account`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});if(!e.ok){const c=await e.json().catch(()=>({error:"Failed to delete account"}));throw new Error(c.error)}this.clearStoredToken(),this.currentUser=null,this.notifyStateChange(null),this.log("Account deleted")}onSuccess(t){if(this.successCallbacks.push(t),this.pendingAuthCode){const e=this.pendingAuthCode;this.pendingAuthCode=null,t(e)}return()=>{const e=this.successCallbacks.indexOf(t);e!==-1&&this.successCallbacks.splice(e,1)}}onError(t){if(this.errorCallbacks.push(t),this.pendingAuthError){const e=this.pendingAuthError;this.pendingAuthError=null,t(e)}return()=>{const e=this.errorCallbacks.indexOf(t);e!==-1&&this.errorCallbacks.splice(e,1)}}onAuthStateChange(t){return this.stateChangeCallbacks.push(t),t(this.currentUser),()=>{const e=this.stateChangeCallbacks.indexOf(t);e!==-1&&this.stateChangeCallbacks.splice(e,1)}}getToken(){return this.getStoredToken()}setToken(t){typeof localStorage<"u"&&localStorage.setItem(F,t),this.checkExistingSession()}ensureInitialized(){if(!this.initialized||!this.appId)throw new Error("Auth module not initialized. Call moddNetwork.auth.init() first.")}async handleAuthCallback(){if(typeof window>"u")return;const t=new URL(window.location.href),e=t.searchParams.get("code"),c=t.searchParams.get("error"),n=t.searchParams.get("error_description");if(c){this.log("Auth error received",{error:c,errorDescription:n}),t.searchParams.delete("error"),t.searchParams.delete("error_description"),window.history.replaceState({},"",t.toString()),this.pendingAuthError={code:c,message:n||c},this.errorCallbacks.forEach(r=>r(this.pendingAuthError));return}if(e){this.log("Auth code received",{code:e.substring(0,20)+"..."}),t.searchParams.delete("code"),window.history.replaceState({},"",t.toString());try{const r=await fetch(`${this.centralServiceUrl}/auth/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e})});if(r.ok){const{token:l}=await r.json();l&&(typeof localStorage<"u"&&localStorage.setItem(F,l),this.log("Session token stored"))}else this.log("Failed to exchange auth code for session token")}catch(r){this.log("Error exchanging auth code:",r)}this.pendingAuthCode=e,this.successCallbacks.forEach(r=>r(e))}}async checkExistingSession(){const t=await this.getUser();t?this.notifyStateChange(t):this.getStoredToken()===null&&this.currentUser!==null&&this.notifyStateChange(null)}notifyStateChange(t){this.currentUser=t,this.stateChangeCallbacks.forEach(e=>e(t))}getStoredToken(){return typeof localStorage>"u"?null:localStorage.getItem(F)}clearStoredToken(){typeof localStorage<"u"&&(localStorage.removeItem(F),localStorage.removeItem(ee))}log(...t){this.debug&&console.log("[modd-auth]",...t)}},te=new Ue;typeof window<"u"&&(window.moddAuth=te);var O={TICK:1,INITIAL_STATE:2,ROOM_JOINED:3,ROOM_CREATED:4,ERROR:5,SNAPSHOT_UPDATE:6,ROOM_LEFT:7,SYNC_HASH:8,CLIENT_LIST_UPDATE:9,BINARY_INPUT:32,BINARY_SNAPSHOT:33};function Y(t){let e=2166136261;for(let c=0;c<t.length;c++)e^=t.charCodeAt(c),e=Math.imul(e,16777619)>>>0;return e}var K=new Map;function x(t){const e=Y(t);K.set(e,t)}function ne(t){const e=Y(t);K.delete(e)}function D(t){return K.get(t)}function Te(t){if(t.clientHash===void 0)return!1;const e=D(t.clientHash);return e&&t.clientId!==e?(t.clientId=e,!0):!1}function re(t,e,c,n){const r=new TextEncoder().encode(t),l=new TextEncoder().encode(e),i=new Uint8Array(3+r.length+2+l.length+4+4),d=new DataView(i.buffer);let o=0;return i[o++]=O.SYNC_HASH,d.setUint16(o,r.length,!0),o+=2,i.set(r,o),o+=r.length,d.setUint16(o,l.length,!0),o+=2,i.set(l,o),o+=l.length,d.setUint32(o,c,!0),o+=4,d.setUint32(o,n,!0),i}function oe(t){if(t.byteLength===0)return null;const e=new DataView(t),c=e.getUint8(0);try{switch(c){case O.TICK:{const n=e.getUint32(1,!0);let r=[],l,i;if(t.byteLength>9){l=e.getUint32(5,!0);const d=e.getUint8(9);let o=10;if(d>0&&o+d<=t.byteLength&&(i=new TextDecoder().decode(new Uint8Array(t,o,d)),o+=d),o>=t.byteLength)return{type:"TICK",frame:n,snapshotFrame:l,snapshotHash:i,inputs:r,events:r};const _=e.getUint8(o);o++;for(let E=0;E<_&&o<t.byteLength;E++){const I=e.getUint32(o,!0);o+=4;const u=e.getUint32(o,!0);o+=4;const C=e.getUint16(o,!0);if(o+=2,o+C>t.byteLength)break;const U=new Uint8Array(t,o,C);o+=C;let s;const p=U[0];if(p===123||p===91)try{const N=new TextDecoder().decode(U);s=JSON.parse(N)}catch{s=U}else s=U;let w;typeof s=="object"&&!(s instanceof Uint8Array)?(s.clientId&&!D(I)&&x(s.clientId),w=s.clientId||D(I)||`hash_${I.toString(16)}`):w=D(I)||`hash_${I.toString(16)}`,r.push({seq:u,data:s,clientId:w,clientHash:I})}}return{type:"TICK",frame:n,snapshotFrame:l,snapshotHash:i,inputs:r,events:r}}case O.INITIAL_STATE:{let n=1;const r=e.getUint32(n,!0);n+=4;const l=e.getUint16(n,!0);if(n+=2,n+l>t.byteLength)return console.error("[modu-network] Buffer overflow reading INITIAL_STATE roomId"),null;const i=new TextDecoder().decode(new Uint8Array(t,n,l));n+=l;const d=e.getUint32(n,!0);if(n+=4,n+d>t.byteLength)return console.error("[modu-network] Buffer overflow reading INITIAL_STATE snapshot"),null;const o=new Uint8Array(t,n,d);n+=d;const _=e.getUint16(n,!0);n+=2;const E=[];for(let I=0;I<_&&n<t.byteLength;I++){const u=e.getUint32(n,!0);n+=4;const C=e.getUint32(n,!0);n+=4;const U=e.getUint32(n,!0);n+=4;const s=e.getUint16(n,!0);if(n+=2,n+s>t.byteLength)break;const p=new Uint8Array(t,n,s);n+=s;let w;const N=p[0];if(N===123||N===91)try{const $=new TextDecoder().decode(p);w=JSON.parse($)}catch{w=p}else w=p;let L;typeof w=="object"&&!(w instanceof Uint8Array)?(w.clientId&&!D(u)&&x(w.clientId),L=w.clientId||D(u)||`hash_${u.toString(16)}`):L=D(u)||`hash_${u.toString(16)}`,E.push({seq:C,frame:U,data:w,clientId:L,clientHash:u})}return{type:"INITIAL_STATE",frame:r,snapshot:o,snapshotHash:"",inputs:E,events:E}}case O.ROOM_CREATED:{let n=1;const r=e.getUint16(n,!0);n+=2;const l=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const i=e.getUint16(n,!0);n+=2;const d=new TextDecoder().decode(new Uint8Array(t,n,i));n+=i;const o=e.getUint32(n,!0);n+=4;const _=new TextDecoder().decode(new Uint8Array(t,n,o)),{snapshot:E,snapshotHash:I}=JSON.parse(_);return{type:"ROOM_CREATED",roomId:l,clientId:d,snapshot:E,snapshotHash:I}}case O.ROOM_JOINED:{let n=1;const r=e.getUint16(n,!0);n+=2;const l=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const i=e.getUint16(n,!0);n+=2;const d=new TextDecoder().decode(new Uint8Array(t,n,i));return{type:"ROOM_JOINED",roomId:l,clientId:d}}case O.ERROR:{const n=e.getUint16(1,!0);return{type:"ERROR",message:new TextDecoder().decode(new Uint8Array(t,3,n))}}case O.SNAPSHOT_UPDATE:{let n=1;const r=e.getUint16(n,!0);n+=2;const l=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const i=e.getUint32(n,!0);n+=4;const d=new TextDecoder().decode(new Uint8Array(t,n,i)),{snapshot:o,snapshotHash:_}=JSON.parse(d);return{type:"SNAPSHOT_UPDATE",roomId:l,snapshot:o,snapshotHash:_}}case O.ROOM_LEFT:{const n=e.getUint16(1,!0);return{type:"ROOM_LEFT",roomId:new TextDecoder().decode(new Uint8Array(t,3,n))}}case O.CLIENT_LIST_UPDATE:{let n=1;const r=e.getUint16(n,!0);n+=2;const l=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const i=e.getUint32(n,!0);n+=4;const d=new TextDecoder().decode(new Uint8Array(t,n,i)),o=JSON.parse(d);return{type:"CLIENT_LIST_UPDATE",roomId:l,clients:o}}case O.BINARY_SNAPSHOT:return{type:"BINARY_SNAPSHOT",binaryData:new Uint8Array(t,1)};default:return null}}catch(n){return console.error("[modu-network] Decode error:",n),null}}async function Ae(t){return t instanceof ArrayBuffer?t:typeof Blob<"u"&&t instanceof Blob?await t.arrayBuffer():new Uint8Array(t).buffer}async function V(t,e){const c=e.snapshot||{},n=e.user||null,r=e.onConnect||(()=>{}),l=e.onDisconnect||(()=>{}),i=e.onError||(v=>console.error("[modu-network]",v)),d=e.onMessage||(()=>{}),o=e.onTick||null,_=e.getStateHash||null,E=e.appId;if(!E)throw new Error("[modu-network] appId is required. Pass appId in connect options.");const I=e.centralServiceUrl||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://localhost:9001":"https://nodes.modd.io");console.log("[modu-network] Central service URL:",I);let u=!1,C=new Set,U=[],s=null,p=null,w=null,N=e.fps||20,L=null,$=0,T=0,le=0,de=0,he=0,ue=0,W=null,G=null,H=0,Q=0,q=0,M=null;function X(v){for(const P of v){const j=P.data||{},b=j.type||P.type;if(b==="join"||b==="reconnect"){const R=j.clientId||P.clientId;R&&x(R)}else if(b==="leave"){const R=j.clientId||P.clientId;R&&ne(R)}}}try{const v={};e.joinToken&&(v.joinToken=e.joinToken);const P=e.authToken||(typeof localStorage<"u"?localStorage.getItem("modd_auth_token"):null);if(P&&!e.joinToken&&(v.authToken=P),e.nodeUrl){const B=e.nodeUrl.match(/:(\d+)/);B&&(v.preferredNodeId=`port_${B[1]}`),console.log("[modu-network] Requesting preferred node:",e.nodeUrl)}const j=`${I}/api/apps/${E}/rooms/${t}/connect`,b=await fetch(j,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)});if(!b.ok){const B=await b.json().catch(()=>({error:`HTTP ${b.status}`}));throw new Error(`Failed to get node assignment: ${B.error||b.statusText}`)}const R=await b.json();p=R.url,w=R.token,N=R.fps||20;const ke=e.nodeUrl&&R.url===e.nodeUrl;console.log("[modu-network] Received Node URL:",p,"token:",w?"yes":"no","fps:",N,ke?"(preferred)":"");const Ee=typeof globalThis<"u"&&globalThis.WebSocket?globalThis.WebSocket:WebSocket;return new Promise((B,ge)=>{L=B;const Ce=w?`${p}?token=${encodeURIComponent(w)}`:p;s=new Ee(Ce),s.binaryType="arraybuffer";const fe={send(h){if(!u||!s||s.readyState!==1)return;if(h instanceof Uint8Array||h instanceof ArrayBuffer){const a=h instanceof Uint8Array?h:new Uint8Array(h),g=new Uint8Array(1+a.length);g[0]=32,g.set(a,1),T+=g.length,s.send(g);return}const y=JSON.stringify({type:"SEND_INPUT",payload:{roomId:t,data:h}});T+=y.length,s.send(y)},sendSnapshot(h,y,a,g){if(!u||!s)return;if(h instanceof Uint8Array||h instanceof ArrayBuffer){const k=h instanceof Uint8Array?h:new Uint8Array(h),m=new TextEncoder().encode(y||""),f=new Uint8Array(10+m.length+k.length);f[0]=35;const S=new DataView(f.buffer);S.setUint32(1,a??0,!0),S.setUint32(5,g??0,!0),f[9]=m.length,f.set(m,10),f.set(k,10+m.length),T+=f.length,s.send(f);return}const A=JSON.stringify({type:"SEND_SNAPSHOT",payload:{roomId:t,snapshot:h,hash:y}});T+=A.length,s.send(A)},leaveRoom(){if(u&&s){const h=JSON.stringify({type:"LEAVE_ROOM",payload:{roomId:t}});T+=h.length,s.send(h)}s&&s.close()},getClients(){if(u&&s&&s.readyState===1){const h=JSON.stringify({type:"GET_CLIENTS",payload:{roomId:t}});T+=h.length,s.send(h)}},close(){s&&s.close()},get connected(){return u},get clientId(){return M},get node(){return p?p.match(/:(\d+)/)?.[1]||p:null},get bandwidthIn(){return he},get bandwidthOut(){return ue},get totalBytesIn(){return $},get totalBytesOut(){return T},get frame(){return q},getLatency(){return"0"}};s.onopen=()=>{W=setInterval(()=>{he=$-le,ue=T-de,le=$,de=T},1e3),_&&(G=setInterval(()=>{if(!(!u||!s||s.readyState!==1))try{const y=_();if(y){const a=re(t,y,H,Q);T+=a.byteLength,s.send(a)}}catch(y){console.warn("[modu-network] Error getting state hash:",y)}},1e3));const h=JSON.stringify({type:"JOIN_ROOM",payload:{roomId:t,user:n}});T+=h.length,s.send(h)},s.onerror=h=>{const y=`Failed to connect to ${p}: ${h.message||"Unknown error"}`;i(y),u||ge(new Error(y))},s.onclose=()=>{u=!1,W&&clearInterval(W),G&&clearInterval(G),l()},s.onmessage=async h=>{let y;try{y=await Ae(h.data)}catch(g){console.warn("[modu-network] Failed to read message data:",g);return}$+=y.byteLength;const a=oe(y);if(a)switch(a.type){case"TICK":{if(!u){U.push(a);break}q=a.frame,Q=a.frame;const g=a.inputs||a.events||[];if(g&&g.length>0){const k=Math.max(...g.map(m=>m.seq||0));k>H&&(H=k)}const A=g.filter(k=>!C.has(k.seq));A.forEach(k=>C.add(k.seq)),A.length>0&&X(A),o&&o(a.frame,A,a.snapshotFrame,a.snapshotHash);break}case"ERROR":{if(a.message==="Room not found"){const g=JSON.stringify({type:"CREATE_ROOM",payload:{roomId:t,snapshot:c,user:n}});T+=g.length,s.send(g)}else i(a.message),ge(new Error(a.message));break}case"ROOM_CREATED":{u=!0,q=0,a.clientId&&(M=a.clientId,x(a.clientId),console.log(`[modu-network] Assigned clientId: ${a.clientId}`)),r(c,[],0,p,N,M),L&&L(fe);break}case"INITIAL_STATE":{console.log("[modu-network] Received INITIAL_STATE, connecting...");const{snapshot:g,frame:A,snapshotHash:k}=a;g&&k&&(g.snapshotHash=k);const m=a.inputs||a.events||[];if(q=A,Q=A,m&&m.length>0){const f=Math.max(...m.map(S=>S.seq||0));f>H&&(H=f),m.forEach(S=>C.add(S.seq))}if(m&&m.length>0&&X(m),u=!0,r(g,m||[],A,p,N,M),U.length>0){U.sort((f,S)=>f.frame-S.frame);for(const f of U){const S=(f.inputs||f.events||[]).filter(J=>!C.has(J.seq));S.forEach(J=>C.add(J.seq)),S.length>0&&X(S);for(const J of S)Te(J);o&&(S.length>0||f.frame>A)&&o(f.frame,S,f.snapshotFrame,f.snapshotHash)}U=[]}L&&L(fe);break}case"ROOM_JOINED":{u=!0,a.clientId&&(M=a.clientId,x(a.clientId),console.log(`[modu-network] Assigned clientId: ${a.clientId}`));break}case"SNAPSHOT_UPDATE":{e.onSnapshot&&e.onSnapshot(a.snapshot,a.snapshotHash);break}case"BINARY_SNAPSHOT":{e.onBinarySnapshot&&e.onBinarySnapshot(a.binaryData);break}case"ROOM_LEFT":{console.log(`[modu-network] Left room ${a.roomId}`);break}case"CLIENT_LIST_UPDATE":{e.onClientsUpdate&&e.onClientsUpdate(a.clients);break}}}})}catch(v){throw new Error(`Failed to get node assignment: ${v.message}`)}}function se(t){return t||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://localhost:9001":"https://nodes.modd.io")}async function ae(t,e={}){const c=se(e.centralServiceUrl),n=e.limit||50,r=e.offset||0,l=`${c}/api/apps/${encodeURIComponent(t)}/rooms/list?limit=${n}&offset=${r}`,i=await fetch(l);if(!i.ok){const d=await i.json().catch(()=>({error:"Unknown error"}));throw new Error(d.error||`Failed to list rooms: ${i.statusText}`)}return await i.json()}async function ie(t,e={}){const c=se(e.centralServiceUrl),n=e.minClients??0,r=e.maxClients??999,l=`${c}/api/apps/${encodeURIComponent(t)}/rooms/random?minClients=${n}&maxClients=${r}`,i=await fetch(l);if(i.status===404)return null;if(!i.ok){const d=await i.json().catch(()=>({error:"Unknown error"}));throw new Error(d.error||`Failed to get random room: ${i.statusText}`)}return await i.json()}var ce=V;return typeof window<"u"&&(window.moddNetwork={connect:V,modd:ce,listRooms:ae,getRandomRoom:ie,auth:te}),Ie(Z)})();
"use strict";var Modu=(()=>{var fn=Object.defineProperty;var mo=Object.getOwnPropertyDescriptor;var yo=Object.getOwnPropertyNames;var go=Object.prototype.hasOwnProperty;var vt=(i,e)=>{for(var t in e)fn(i,t,{get:e[t],enumerable:!0})},xo=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of yo(e))!go.call(i,o)&&o!==t&&fn(i,o,{get:()=>e[o],enumerable:!(n=mo(e,o))||n.enumerable});return i};var vo=i=>xo(fn({},"__esModule",{value:!0}),i);var fr={};vt(fr,{AutoRenderer:()=>lt,BODY_DYNAMIC:()=>ci,BODY_KINEMATIC:()=>nt,BODY_STATIC:()=>tt,Body2D:()=>K,Camera2D:()=>Q,CameraSystem:()=>Lt,Entity:()=>it,EntityBuilder:()=>rt,EntityIdAllocator:()=>ke,EntityPool:()=>Pe,FP_2PI:()=>Nn,FP_HALF:()=>J,FP_HALF_PI:()=>Ln,FP_ONE:()=>v,FP_PI:()=>_n,FP_SHIFT:()=>Vn,Game:()=>at,INDEX_MASK:()=>E,InputPlugin:()=>Nt,MAX_ENTITIES:()=>Z,Physics2DSystem:()=>ft,Player:()=>ie,Prefab:()=>st,QueryEngine:()=>Ve,QueryIterator:()=>te,RollbackBuffer:()=>Pt,SHAPE_CIRCLE:()=>Me,SHAPE_RECT:()=>Mt,SPRITE_IMAGE:()=>kt,SYSTEM_PHASES:()=>Qe,Simple2DRenderer:()=>lt,SparseSnapshotCodec:()=>be,Sprite:()=>et,SystemScheduler:()=>_e,Transform2D:()=>$,World:()=>Ne,addLocalInput:()=>lo,addPlayer:()=>oo,addPlayerAtFrame:()=>ro,addRemoteInput:()=>co,advanceFrame:()=>po,checkRollback:()=>Rn,clearSnapshotsBefore:()=>so,codec:()=>xn,createGame:()=>di,createPhysics2DSystem:()=>Pi,createRollbackManager:()=>io,dRandom:()=>li,dSqrt:()=>Un,defineComponent:()=>ne,disableDeterminismGuard:()=>pi,enableDebugUI:()=>yi,enableDeterminismGuard:()=>qt,fpAbs:()=>b,fpAtan2:()=>qn,fpCeil:()=>Yn,fpClamp:()=>we,fpCos:()=>ge,fpDiv:()=>S,fpFloor:()=>On,fpMax:()=>re,fpMin:()=>ee,fpMul:()=>p,fpSign:()=>zn,fpSin:()=>ce,fpSqrt:()=>M,getInputsForFrame:()=>pn,getInputsToSend:()=>uo,getRollbackStats:()=>ho,getSyncState:()=>fo,loadRandomState:()=>Re,loadSnapshot:()=>Bn,performRollback:()=>An,physics2d:()=>Tn,physics3d:()=>wn,quatClone:()=>ai,quatConjugate:()=>Bt,quatFromAxisAngle:()=>Tt,quatFromEulerY:()=>si,quatIdentity:()=>Ze,quatMul:()=>Dt,quatNormalize:()=>wt,quatRotateVec3:()=>G,removePlayer:()=>ao,saveRandomState:()=>Be,saveSnapshot:()=>un,toFixed:()=>y,toFloat:()=>T,vec2:()=>Xn,vec2Add:()=>Wn,vec2Clone:()=>Hn,vec2Cross:()=>Zn,vec2Distance:()=>ei,vec2DistanceSq:()=>ti,vec2Dot:()=>Kn,vec2FromFixed:()=>$n,vec2Length:()=>Ct,vec2LengthSq:()=>Ft,vec2Lerp:()=>Jn,vec2Neg:()=>jn,vec2Normalize:()=>Qn,vec2Scale:()=>Gn,vec2Sub:()=>bt,vec2Zero:()=>hn,vec3:()=>k,vec3Add:()=>_,vec3Clone:()=>It,vec3Cross:()=>j,vec3Distance:()=>oi,vec3DistanceSq:()=>ri,vec3Dot:()=>N,vec3FromFloats:()=>xe,vec3Length:()=>Et,vec3LengthSq:()=>W,vec3Lerp:()=>ii,vec3Neg:()=>de,vec3Normalize:()=>ae,vec3Scale:()=>D,vec3Sub:()=>V,vec3ToFloats:()=>ni,vec3Zero:()=>se});var Vn=16,v=65536,J=32768,_n=205887,Nn=411775,Ln=102944;function y(i){return Math.round(i*65536)}function T(i){return i/65536}function p(i,e){return Number(BigInt(i)*BigInt(e)>>BigInt(16))}function S(i,e){return e===0?i>=0?2147483647:-2147483647:Number((BigInt(i)<<BigInt(16))/BigInt(e))}function b(i){return i<0?-i:i}function zn(i){return i>0?65536:i<0?-65536:0}function ee(i,e){return i<e?i:e}function re(i,e){return i>e?i:e}function we(i,e,t){return i<e?e:i>t?t:i}function On(i){return i&-65536}function Yn(i){return i+65536-1&-65536}function M(i){if(i<=0)return 0;let e=BigInt(i)*BigInt(65536);if(e<=0n)return 0;let t=0n,n=e;for(;n>0n;)t++,n>>=1n;let o=1n<<(t>>1n);o===0n&&(o=1n);let r=0n;for(let s=0;s<30;s++){let a=o+e/o>>1n;if(a===o||a===r)break;r=o,o=a}for(;o*o>e;)o--;for(;(o+1n)*(o+1n)<=e;)o++;return Number(o)}function Un(i){return T(M(y(i)))}var St=256,Pn=[0,402,804,1206,1608,2010,2412,2814,3216,3617,4019,4420,4821,5222,5623,6023,6424,6824,7224,7623,8022,8421,8820,9218,9616,10014,10411,10808,11204,11600,11996,12391,12785,13180,13573,13966,14359,14751,15143,15534,15924,16314,16703,17091,17479,17867,18253,18639,19024,19409,19792,20175,20557,20939,21320,21699,22078,22457,22834,23210,23586,23961,24335,24708,25080,25451,25821,26190,26558,26925,27291,27656,28020,28383,28745,29106,29466,29824,30182,30538,30893,31248,31600,31952,32303,32652,33e3,33347,33692,34037,34380,34721,35062,35401,35738,36075,36410,36744,37076,37407,37736,38064,38391,38716,39040,39362,39683,40002,40320,40636,40951,41264,41576,41886,42194,42501,42806,43110,43412,43713,44011,44308,44604,44898,45190,45480,45769,46056,46341,46624,46906,47186,47464,47741,48015,48288,48559,48828,49095,49361,49624,49886,50146,50404,50660,50914,51166,51417,51665,51911,52156,52398,52639,52878,53114,53349,53581,53812,54040,54267,54491,54714,54934,55152,55368,55582,55794,56004,56212,56418,56621,56823,57022,57219,57414,57607,57798,57986,58172,58356,58538,58718,58896,59071,59244,59415,59583,59750,59914,60075,60235,60392,60547,60700,60851,60999,61145,61288,61429,61568,61705,61839,61971,62101,62228,62353,62476,62596,62714,62830,62943,63054,63162,63268,63372,63473,63572,63668,63763,63854,63944,64031,64115,64197,64277,64354,64429,64501,64571,64639,64704,64766,64827,64884,64940,64993,65043,65091,65137,65180,65220,65259,65294,65328,65358,65387,65413,65436,65457,65476,65492,65505,65516,65525,65531,65535,65536],So=10680707;function ce(i){if(i<0){let u=(-i/411775|0)+1;i+=u*411775}i>=411775&&(i=i%411775);let e=0;i>=205887&&(i-=205887,e=2),i>=102944&&(i=205887-i,e+=1);let t=p(i,So),n=t>>16,o=t&65535,r=n<0?0:n>St?St:n,s=n+1,a=s<0?0:s>St?St:s,l=Pn[r]??0,c=Pn[a]??65536,d=l+p(c-l,o);return e>=2&&(d=-d),d}function ge(i){return ce(i+102944)}function qn(i,e){if(e===0&&i===0)return 0;let t=b(e),n=b(i),o;if(t>=n){let r=S(n,t);o=p(r,51472)}else{let r=S(t,n);o=102944-p(r,51472)}return e<0&&(o=205887-o),i<0&&(o=-o),o}function Xn(i,e){return{x:y(i),y:y(e)}}function hn(){return{x:0,y:0}}function $n(i,e){return{x:i,y:e}}function Hn(i){return{x:i.x,y:i.y}}function Wn(i,e){return{x:i.x+e.x,y:i.y+e.y}}function bt(i,e){return{x:i.x-e.x,y:i.y-e.y}}function Gn(i,e){return{x:p(i.x,e),y:p(i.y,e)}}function jn(i){return{x:-i.x,y:-i.y}}function Kn(i,e){return p(i.x,e.x)+p(i.y,e.y)}function Zn(i,e){return p(i.x,e.y)-p(i.y,e.x)}function Ft(i){return p(i.x,i.x)+p(i.y,i.y)}function Ct(i){return M(Ft(i))}function Qn(i){let e=Ct(i);return e===0?hn():{x:S(i.x,e),y:S(i.y,e)}}function Jn(i,e,t){let n=65536-t;return{x:p(i.x,n)+p(e.x,t),y:p(i.y,n)+p(e.y,t)}}function ei(i,e){return Ct(bt(e,i))}function ti(i,e){return Ft(bt(e,i))}function k(i,e,t){return{x:i,y:e,z:t}}function se(){return{x:0,y:0,z:0}}function xe(i,e,t){return{x:y(i),y:y(e),z:y(t)}}function ni(i){return{x:T(i.x),y:T(i.y),z:T(i.z)}}function It(i){return{x:i.x,y:i.y,z:i.z}}function _(i,e){return{x:i.x+e.x,y:i.y+e.y,z:i.z+e.z}}function V(i,e){return{x:i.x-e.x,y:i.y-e.y,z:i.z-e.z}}function D(i,e){return{x:p(i.x,e),y:p(i.y,e),z:p(i.z,e)}}function de(i){return{x:-i.x,y:-i.y,z:-i.z}}function N(i,e){return p(i.x,e.x)+p(i.y,e.y)+p(i.z,e.z)}function j(i,e){return{x:p(i.y,e.z)-p(i.z,e.y),y:p(i.z,e.x)-p(i.x,e.z),z:p(i.x,e.y)-p(i.y,e.x)}}function W(i){return p(i.x,i.x)+p(i.y,i.y)+p(i.z,i.z)}function Et(i){return M(W(i))}function ae(i){let e=Et(i);return e===0?se():{x:S(i.x,e),y:S(i.y,e),z:S(i.z,e)}}function ii(i,e,t){let n=65536-t;return{x:p(i.x,n)+p(e.x,t),y:p(i.y,n)+p(e.y,t),z:p(i.z,n)+p(e.z,t)}}function oi(i,e){return Et(V(e,i))}function ri(i,e){return W(V(e,i))}function Ze(){return{x:0,y:0,z:0,w:65536}}function Tt(i,e){let t=e>>1,n=ce(t),o=ge(t),r=ae(i);return{x:p(r.x,n),y:p(r.y,n),z:p(r.z,n),w:o}}function si(i){let e=i>>1;return{x:0,y:ce(e),z:0,w:ge(e)}}function Dt(i,e){return{x:p(i.w,e.x)+p(i.x,e.w)+p(i.y,e.z)-p(i.z,e.y),y:p(i.w,e.y)-p(i.x,e.z)+p(i.y,e.w)+p(i.z,e.x),z:p(i.w,e.z)+p(i.x,e.y)-p(i.y,e.x)+p(i.z,e.w),w:p(i.w,e.w)-p(i.x,e.x)-p(i.y,e.y)-p(i.z,e.z)}}function G(i,e){let t=k(i.x,i.y,i.z),n=j(t,e),o=j(t,n);return _(e,_(D(n,i.w<<1),D(o,131072)))}function wt(i){let e=p(i.x,i.x)+p(i.y,i.y)+p(i.z,i.z)+p(i.w,i.w),t=M(e);return t===0?Ze():{x:S(i.x,t),y:S(i.y,t),z:S(i.z,t),w:S(i.w,t)}}function Bt(i){return{x:-i.x,y:-i.y,z:-i.z,w:i.w}}function ai(i){return{x:i.x,y:i.y,z:i.z,w:i.w}}var pe=1,ve=2;function bo(){let i=pe,e=ve;return pe=e,i^=i<<23>>>0,i^=i>>>17,i^=e,i^=e>>>26,ve=i>>>0,pe+ve>>>0}function Fo(i){i=i>>>0,i===0&&(i=1);let e=i;e=(e>>>16^e)*73244475>>>0,e=(e>>>16^e)*73244475>>>0,pe=(e>>>16^e)>>>0,e=i*2654435769>>>0,e=(e>>>16^e)*73244475>>>0,e=(e>>>16^e)*73244475>>>0,ve=(e>>>16^e)>>>0,pe===0&&ve===0&&(pe=1)}function li(){return bo()/4294967296}function Be(){return{s0:pe,s1:ve}}function Re(i){pe=i.s0,ve=i.s1}Fo(1);var Z=1e4;var E=1048575;var Qe=["input","update","prePhysics","physics","postPhysics","render"];function Co(i){if(typeof i=="object"&&i!==null&&"type"in i){let e=i;return e.type==="f32"&&console.warn("Component field uses f32 which is NON-DETERMINISTIC. Only use for render-only data, never for synced state."),{type:e.type,default:e.default??(e.type==="bool"?!1:0)}}if(typeof i=="boolean")return{type:"bool",default:i};if(typeof i=="number")return{type:"i32",default:i};if(i==null)return{type:"i32",default:0};throw new Error(`Unsupported field type: ${typeof i}. Components can only contain numbers and booleans. Use game.internString() for string values.`)}function Io(i){switch(i){case"i32":return new Int32Array(1e4);case"u8":case"bool":return new Uint8Array(1e4);case"f32":return new Float32Array(1e4);default:throw new Error(`Unknown field type: ${i}`)}}function Eo(i){let e={};for(let[t,n]of Object.entries(i))e[t]=Io(n.type);return{mask:new Uint32Array(Math.ceil(1e4/32)),fields:e,schema:i}}function To(i,e,t){let n=function(o){this._index=o};n.prototype={};for(let[o,r]of Object.entries(e)){let s=t.fields[o],a=r.type==="i32",l=r.type==="bool";Object.defineProperty(n.prototype,o,{get:function(){let c=s[this._index];return l?c!==0:a?T(c):c},set:function(c){l?s[this._index]=c?1:0:a?s[this._index]=y(c):s[this._index]=c},enumerable:!0,configurable:!1})}return Object.defineProperty(n.prototype,"_index",{value:0,writable:!0,enumerable:!1,configurable:!1}),n}var mn=new Map;function ne(i,e,t){if(mn.has(i))throw new Error(`Component '${i}' is already defined`);let n={};for(let[a,l]of Object.entries(e))n[a]=Co(l);let o=Eo(n),r=To(i,n,o),s={name:i,schema:n,storage:o,AccessorClass:r,fieldNames:Object.keys(n),sync:t?.sync!==!1};return mn.set(i,s),s}function ue(i,e){let t=e>>>5,n=1<<(e&31);return(i.mask[t]&n)!==0}function Se(i,e){let t=e>>>5,n=1<<(e&31);i.mask[t]|=n}function Ae(i,e){let t=e>>>5,n=1<<(e&31);i.mask[t]&=~n}function Je(i,e){for(let[t,n]of Object.entries(i.schema)){let o=i.fields[t];n.type==="i32"?o[e]=y(n.default):n.type==="bool"?o[e]=n.default?1:0:o[e]=n.default}}function Rt(){return mn}var ke=class{constructor(){this.freeList=[];this.nextIndex=0;this.generations=new Uint16Array(1e4)}allocate(){let e;if(this.freeList.length>0)e=this.freeList.shift();else{if(this.nextIndex>=1e4)throw new Error(`Entity limit exceeded (MAX_ENTITIES=${1e4}). Consider destroying unused entities or increasing the limit.`);e=this.nextIndex++}return this.generations[e]<<20|e}free(e){let t=e&1048575;this.generations[t]=this.generations[t]+1&4095;let n=this.findInsertIndex(t);this.freeList.splice(n,0,t)}isValid(e){let t=e&1048575,n=e>>>20;return t<this.nextIndex&&this.generations[t]===n}getIndex(e){return e&1048575}getGeneration(e){return e>>>20}getState(){return{nextIndex:this.nextIndex,freeList:[...this.freeList],generations:Array.from(this.generations.slice(0,this.nextIndex))}}setState(e){this.nextIndex=e.nextIndex,this.freeList=[...e.freeList];for(let t=0;t<e.generations.length;t++)this.generations[t]=e.generations[t]}reset(){this.nextIndex=0,this.freeList=[],this.generations.fill(0)}getActiveCount(){return this.nextIndex-this.freeList.length}getNextId(){return this.nextIndex}setNextId(e){this.nextIndex=e}allocateSpecific(e){let t=e&1048575,n=e>>>20;t>=this.nextIndex&&(this.nextIndex=t+1);let o=this.freeList.indexOf(t);return o!==-1&&this.freeList.splice(o,1),this.generations[t]=n,e}findInsertIndex(e){let t=0,n=this.freeList.length;for(;t<n;){let o=t+n>>>1;this.freeList[o]<e?t=o+1:n=o}return t}};var $=ne("Transform2D",{x:0,y:0,angle:0}),K=ne("Body2D",{vx:0,vy:0,angularVelocity:0,forceX:0,forceY:0,impulseX:0,impulseY:0,width:0,height:0,radius:0,mass:1,restitution:0,friction:0,bodyType:0,shapeType:1,damping:0,isSensor:!1}),ie=ne("Player",{clientId:0}),et=ne("Sprite",{shape:1,width:0,height:0,radius:10,color:0,spriteId:0,offsetX:0,offsetY:0,scaleX:1,scaleY:1,layer:0,visible:!0}),kt=2,Q=ne("Camera2D",{x:0,y:0,zoom:1,targetZoom:1,smoothing:.1,followEntity:0,viewportWidth:0,viewportHeight:0},{sync:!1}),ci=0,tt=1,nt=2,Mt=0,Me=1;var it=class{constructor(){this.eid=-1;this.type="";this.destroyed=!1;this.render={prevX:0,prevY:0,interpX:0,interpY:0,screenX:0,screenY:0,visible:!0};this._components=[];this._accessors=new Map;this._world=null;this._inputData=null}get(e){let t=this.eid&1048575;if(!ue(e.storage,t))throw new Error(`Entity ${this.eid} (type: ${this.type}) does not have component '${e.name}'`);let n=this._accessors.get(e);return n?n._index=t:(n=new e.AccessorClass(t),this._accessors.set(e,n)),n}has(e){return ue(e.storage,this.eid&1048575)}addComponent(e,t){let n=this.eid&1048575;if(ue(e.storage,n))throw new Error(`Entity ${this.eid} already has component '${e.name}'`);Se(e.storage,n),Je(e.storage,n),this._components.push(e),this._world&&this._world.queryEngine.addComponent(this.eid,e);let o=this.get(e);if(t)for(let[r,s]of Object.entries(t))o[r]=s;return o}removeComponent(e){let t=this.eid&1048575;if(!ue(e.storage,t))throw new Error(`Entity ${this.eid} does not have component '${e.name}'`);Ae(e.storage,t);let n=this._components.indexOf(e);n!==-1&&this._components.splice(n,1),this._world&&this._world.queryEngine.removeComponent(this.eid,e),this._accessors.delete(e)}destroy(){this.destroyed||(this.destroyed=!0,this._world&&this._world.destroyEntity(this))}getComponents(){return[...this._components]}get input(){return this._inputData}_setInputData(e){this._inputData=e}_savePreviousState(){for(let e of this._components){let t=this.eid&1048575;if("x"in e.storage.fields&&"y"in e.storage.fields){let n=e.storage.fields.x,o=e.storage.fields.y;this.render.prevX=T(n[t]),this.render.prevY=T(o[t]);return}}}interpolate(e){for(let t of this._components){let n=this.eid&1048575;if("x"in t.storage.fields&&"y"in t.storage.fields){let o=T(t.storage.fields.x[n]),r=T(t.storage.fields.y[n]);this.render.interpX=this.render.prevX+(o-this.render.prevX)*e,this.render.interpY=this.render.prevY+(r-this.render.prevY)*e;return}}}_init(e,t,n,o){this.eid=e,this.type=t,this.destroyed=!1,this._components=n,this._world=o,this._accessors.clear(),this.render.prevX=0,this.render.prevY=0,this.render.interpX=0,this.render.interpY=0,this.render.screenX=0,this.render.screenY=0,this.render.visible=!0,this._inputData=null}_cleanup(){this._world=null,this._components=[],this._accessors.clear(),this._inputData=null}moveTowards(e,t){if(!this.has($)||!this.has(K))return;let n=this.get($),o=this.get(K),r=y(e.x)-y(n.x),s=y(e.y)-y(n.y),a=p(r,r)+p(s,s);if(a===0){o.vx=0,o.vy=0;return}let l=M(a),c=y(t*60);o.vx=T(S(p(r,c),l)),o.vy=T(S(p(s,c),l))}stop(){if(!this.has(K))return;let e=this.get(K);e.vx=0,e.vy=0}setVelocity(e,t){if(!this.has(K))return;let n=this.get(K);n.vx=e,n.vy=t}distanceTo(e){if(!this.has($))return 0;let t=this.get($),n=y(e.x)-y(t.x),o=y(e.y)-y(t.y),r=p(n,n)+p(o,o);return T(M(r))}isWithin(e,t){if(!this.has($))return!1;let n=this.get($),o=y(e.x)-y(n.x),r=y(e.y)-y(n.y),s=p(o,o)+p(r,r),a=y(t),l=p(a,a);return s<=l}},Pe=class{constructor(){this.pool=[];this.active=new Map}acquire(e){let t=this.active.get(e);return t||(t=this.pool.pop()||new it,this.active.set(e,t),t)}release(e){let t=this.active.get(e);t&&(t._cleanup(),this.active.delete(e),this.pool.push(t))}get(e){return this.active.get(e)}has(e){return this.active.has(e)}clear(){for(let e of this.active.values())e._cleanup(),this.pool.push(e);this.active.clear()}get size(){return this.active.size}};var te=class{constructor(e,t,n){this.index=0;this.eids=e.slice(),this.getEntity=t,this.isDestroyed=n}[Symbol.iterator](){return this.index=0,{next:()=>{for(;this.index<this.eids.length;){let e=this.eids[this.index++];if(this.isDestroyed(e))continue;let t=this.getEntity(e);if(t)return{done:!1,value:t}}return{done:!0,value:void 0}}}}toArray(){let e=[];for(let t of this)e.push(t);return e}first(){for(let e of this)return e;return null}find(e){for(let t of this)if(e(t))return t;return null}count(){let e=0;for(let t of this)e++;return e}},Ve=class{constructor(e,t){this.typeIndex=new Map;this.componentIndex=new Map;this.clientIdIndex=new Map;this.getEntity=e,this.isDestroyed=t}addEntity(e,t,n,o){let r=this.typeIndex.get(t);r||(r=new Set,this.typeIndex.set(t,r)),r.add(e);for(let s of n){let a=this.componentIndex.get(s);a||(a=new Set,this.componentIndex.set(s,a)),a.add(e)}o!==void 0&&this.clientIdIndex.set(o,e)}removeEntity(e,t,n,o){this.typeIndex.get(t)?.delete(e);for(let r of n)this.componentIndex.get(r)?.delete(e);o!==void 0&&this.clientIdIndex.delete(o)}addComponent(e,t){let n=this.componentIndex.get(t);n||(n=new Set,this.componentIndex.set(t,n)),n.add(e)}removeComponent(e,t){this.componentIndex.get(t)?.delete(e)}setClientId(e,t){this.clientIdIndex.set(t,e)}removeClientId(e){this.clientIdIndex.delete(e)}byType(e){let t=this.typeIndex.get(e),n=t?this.sortedEids(t):[];return new te(n,this.getEntity,this.isDestroyed)}byComponents(...e){if(e.length===0)return new te([],this.getEntity,this.isDestroyed);let t,n=1/0;for(let r of e){let s=this.componentIndex.get(r);if(!s||s.size===0)return new te([],this.getEntity,this.isDestroyed);s.size<n&&(n=s.size,t=s)}if(!t)return new te([],this.getEntity,this.isDestroyed);let o=[];for(let r of t){let s=!0;for(let a of e)if(a.storage&&!ue(a.storage,r&1048575)){s=!1;break}s&&o.push(r)}return o.sort((r,s)=>r-s),new te(o,this.getEntity,this.isDestroyed)}query(e,...t){if(typeof e=="string"){if(t.length>0){let n=this.typeIndex.get(e);if(!n||n.size===0)return new te([],this.getEntity,this.isDestroyed);let o=[];for(let r of n){let s=!0;for(let a of t)if(a.storage&&!ue(a.storage,r&1048575)){s=!1;break}s&&o.push(r)}return o.sort((r,s)=>r-s),new te(o,this.getEntity,this.isDestroyed)}return this.byType(e)}return this.byComponents(e,...t)}getByClientId(e){return this.clientIdIndex.get(e)}getAllEids(){let e=new Set;for(let t of this.typeIndex.values())for(let n of t)e.add(n);return Array.from(e).sort((t,n)=>t-n)}clear(){this.typeIndex.clear(),this.componentIndex.clear(),this.clientIdIndex.clear()}sortedEids(e){return Array.from(e).sort((t,n)=>t-n)}};var _e=class{constructor(){this.systems=new Map;this.isClient=!0;this.nextSystemId=0;for(let e of Qe)this.systems.set(e,[])}setIsClient(e){this.isClient=e}add(e,t={}){let n=t.phase||"update",o=this.systems.get(n);if(!o)throw new Error(`Unknown system phase: ${n}`);let r={fn:e,options:t,order:t.order??this.nextSystemId++};return o.push(r),o.sort((s,a)=>s.order-a.order),()=>this.remove(e)}remove(e){for(let t of this.systems.values()){let n=t.findIndex(o=>o.fn===e);if(n!==-1)return t.splice(n,1),!0}return!1}runPhase(e){let t=this.systems.get(e);if(t){for(let n of t)if(!(n.options.client&&!this.isClient)&&!(n.options.server&&this.isClient))try{let o=n.fn();if(o&&typeof o=="object"&&"then"in o)throw new Error("System returned a Promise. Async systems are not allowed as they break determinism. Remove 'await' from your system.")}catch(o){throw console.error(`Error in system during '${e}' phase:`,o),o}}}runAll(){for(let e of Qe)e==="render"&&!this.isClient||this.runPhase(e)}getSystemCounts(){let e={};for(let[t,n]of this.systems)e[t]=n.length;return e}clear(){for(let e of this.systems.values())e.length=0;this.nextSystemId=0}};var be=class{encode(e,t,n,o,r,s,a=0,l=0,c){let d=new Uint32Array(Math.ceil(1e4/32)),u=[],f=[...e].sort((g,x)=>g-x);for(let g of f){let x=g&1048575;d[x>>>5]|=1<<(x&31),u.push({eid:g,type:t(g),clientId:n(g)})}let h=new Map,m=Rt();for(let[g,x]of m){if(!x.sync||x.fieldNames.length===0)continue;let C=0;for(let B of x.fieldNames){let R=x.storage.fields[B];C+=f.length*R.BYTES_PER_ELEMENT}let w=new ArrayBuffer(C),U=0;for(let B of x.fieldNames){let R=x.storage.fields[B],Y=R.BYTES_PER_ELEMENT,L=new R.constructor(w,U,f.length);for(let X=0;X<f.length;X++){let H=f[X]&1048575;L[X]=R[H]}U+=f.length*Y}h.set(g,w)}return{frame:a,seq:l,entityMask:d,entityMeta:u,componentData:h,entityCount:f.length,allocator:r,strings:s,rng:c}}decode(e,t,n,o,r,s){t(),n(e.allocator),o(e.strings),e.rng&&s&&s(e.rng);let a=Rt();for(let l=0;l<e.entityMeta.length;l++){let c=e.entityMeta[l];r(c.eid,c.type,c.clientId)}for(let[l,c]of e.componentData){let d=a.get(l);if(!d)continue;let u=0;for(let f of d.fieldNames){let h=d.storage.fields[f],m=h.BYTES_PER_ELEMENT,g=new h.constructor(c,u,e.entityCount);for(let x=0;x<e.entityMeta.length;x++){let F=e.entityMeta[x].eid&1048575;h[F]=g[x]}u+=e.entityCount*m}}}getSize(e){let t=0;t+=e.entityMask.byteLength,t+=e.entityMeta.length*32;for(let n of e.componentData.values())t+=n.byteLength;return t+=e.allocator.freeList.length*4,t+=e.allocator.generations.length*2,t}toBinary(e){let t=JSON.stringify({frame:e.frame,seq:e.seq,entityMeta:e.entityMeta,allocator:e.allocator,strings:e.strings,rng:e.rng,componentNames:Array.from(e.componentData.keys())}),n=new TextEncoder().encode(t),o=n.length,r=0,s=[];for(let u of e.componentData.values())s.push(u.byteLength),r+=u.byteLength;let a=4+o+4+e.entityMask.byteLength+r,l=new ArrayBuffer(a),c=new DataView(l),d=0;c.setUint32(d,o,!0),d+=4,new Uint8Array(l,d,o).set(n),d+=o,c.setUint32(d,e.entityMask.byteLength,!0),d+=4,new Uint8Array(l,d,e.entityMask.byteLength).set(new Uint8Array(e.entityMask.buffer)),d+=e.entityMask.byteLength;for(let u of e.componentData.values())new Uint8Array(l,d,u.byteLength).set(new Uint8Array(u)),d+=u.byteLength;return l}fromBinary(e){let t=new DataView(e),n=0,o=t.getUint32(n,!0);n+=4;let r=new Uint8Array(e,n,o),s=new TextDecoder().decode(r),a=JSON.parse(s);n+=o;let l=t.getUint32(n,!0);n+=4;let c=new Uint32Array(e.slice(n,n+l));n+=l;let d=new Map,u=Rt();for(let f of a.componentNames){let h=u.get(f);if(!h)continue;let m=0;for(let x of h.fieldNames){let F=h.storage.fields[x];m+=a.entityMeta.length*F.BYTES_PER_ELEMENT}let g=e.slice(n,n+m);d.set(f,g),n+=m}return{frame:a.frame,seq:a.seq,entityMask:c,entityMeta:a.entityMeta,componentData:d,entityCount:a.entityMeta.length,allocator:a.allocator,strings:a.strings,rng:a.rng}}},Pt=class{constructor(e=60){this.maxFrames=e;this.snapshots=new Map;this.codec=new be}save(e,t){this.snapshots.set(e,t);let n=e-this.maxFrames+1;for(let o of this.snapshots.keys())o<n&&this.snapshots.delete(o)}get(e){return this.snapshots.get(e)}has(e){return this.snapshots.has(e)}getOldestFrame(){let e;for(let t of this.snapshots.keys())(e===void 0||t<e)&&(e=t);return e}getNewestFrame(){let e;for(let t of this.snapshots.keys())(e===void 0||t>e)&&(e=t);return e}clear(){this.snapshots.clear()}get size(){return this.snapshots.size}};var Vt=class{constructor(){this.stringToId=new Map;this.idToString=new Map;this.nextId=new Map}intern(e,t){let n=this.stringToId.get(e);n||(n=new Map,this.stringToId.set(e,n));let o=n.get(t);if(o!==void 0)return o;let r=this.nextId.get(e)??1;this.nextId.set(e,r+1),n.set(t,r);let s=this.idToString.get(e);return s||(s=new Map,this.idToString.set(e,s)),s.set(r,t),r}getString(e,t){return this.idToString.get(e)?.get(t)??null}getState(){let e={},t={};for(let[n,o]of this.stringToId)e[n]=Object.fromEntries(o),t[n]=this.nextId.get(n)??1;return{tables:e,nextIds:t}}setState(e){this.stringToId.clear(),this.idToString.clear(),this.nextId.clear();for(let[t,n]of Object.entries(e.tables)){let o=new Map(Object.entries(n));this.stringToId.set(t,o);let r=new Map;for(let[s,a]of o)r.set(a,s);this.idToString.set(t,r),this.nextId.set(t,e.nextIds[t]??1)}}clear(){this.stringToId.clear(),this.idToString.clear(),this.nextId.clear()}};var ot=class{constructor(e){this.frame=e,this.inputs=new Map,this.confirmed=!1}getSortedInputs(){let e=Array.from(this.inputs.entries());return e.sort((t,n)=>t[0]-n[0]),e}},_t=class{constructor(e=120){this.history=new Map;this.maxFrames=e}setInput(e,t,n){let o=this.history.get(e);o||(o=new ot(e),this.history.set(e,o)),o.inputs.set(t,n)}confirmFrame(e,t){let n=new ot(e);n.confirmed=!0;for(let[o,r]of t)n.inputs.set(o,r);this.history.set(e,n)}getFrame(e){return this.history.get(e)}getRange(e,t){if(e>t)return[];let n=[];for(let[o,r]of this.history)o>=e&&o<=t&&n.push(r);return n.sort((o,r)=>o.frame-r.frame),n}prune(e){let t=[];for(let n of this.history.keys())n<e&&t.push(n);for(let n of t)this.history.delete(n)}getState(){let e=[],t=Array.from(this.history.entries()).sort((n,o)=>n[0]-o[0]);for(let[,n]of t){let o=n.getSortedInputs().map(([r,s])=>({clientId:r,data:s}));e.push({frame:n.frame,inputs:o,confirmed:n.confirmed})}return{frames:e}}setState(e){this.history.clear();for(let t of e.frames){let n=new ot(t.frame);n.confirmed=t.confirmed;for(let{clientId:o,data:r}of t.inputs)n.inputs.set(o,r);this.history.set(t.frame,n)}}get size(){return this.history.size}clear(){this.history.clear()}};var rt=class{constructor(e,t){this.world=e;this.name=t;this.components=[];this.registered=!1}with(e,t){return this.components.push({type:e,defaults:t}),this.register(),this}_setSyncFields(e){this._syncFields=e}_setOnRestore(e){this._onRestore=e}register(){this.world._registerEntityDef({name:this.name,components:this.components,syncFields:this._syncFields,onRestore:this._onRestore})}_ensureRegistered(){this.registered||(this.registered=!0),this.register()}_getDefinition(){return{name:this.name,components:this.components,syncFields:this._syncFields,onRestore:this._onRestore}}},Ne=class{constructor(){this.entityDefs=new Map;this.activeEntities=new Set;this.entityTypes=new Map;this.entityComponents=new Map;this.entityClientIds=new Map;this.inputRegistry=new Map;this._isClient=!0;this.snapshotCodec=new be;this.frame=0;this.seq=0;this.inputBuffer=new Map;this._isSimulating=!1;this.localClientId=null;this.predictions=[];this.rollbackBuffer=new Map;this.rollbackBufferSize=60;this.inputHistory=new _t(120);this.idAllocator=new ke,this.entityPool=new Pe,this.strings=new Vt,this.queryEngine=new Ve(e=>this.getEntity(e),e=>this.isDestroyed(e)),this.scheduler=new _e,this.addSystem(()=>this.saveInterpolationState(),{phase:"prePhysics",order:-1e3})}setIsClient(e){this._isClient=e,this.scheduler.setIsClient(e)}get isClient(){return this._isClient}defineComponent(e,t){return ne(e,t)}defineEntity(e){return new rt(this,e)}_registerEntityDef(e){this.entityDefs.set(e.name,e)}getEntityDef(e){return this.entityDefs.get(e)}spawn(e,t={}){let n;if(typeof e=="string")n=e;else{let d=e._getDefinition();this._registerEntityDef(d),n=d.name}let o=this.entityDefs.get(n);if(!o)throw new Error(`Unknown entity type: '${n}'`);let r=this.idAllocator.allocate(),s=r&1048575,a=this.entityPool.acquire(r);this.activeEntities.add(r),this.entityTypes.set(r,n);let l=[];for(let d of o.components){let u=d.type;if(l.push(u),Se(u.storage,s),Je(u.storage,s),d.defaults)for(let[f,h]of Object.entries(d.defaults)){let m=u.storage.fields[f];if(m){let g=u.storage.schema[f];g.type==="i32"?m[s]=y(h):g.type==="bool"?m[s]=h?1:0:m[s]=h}}}let c;for(let[d,u]of Object.entries(t)){d==="clientId"&&(c=u,this.entityClientIds.set(r,c));for(let f of l)if(d in f.storage.schema){let h=f.storage.fields[d],m=f.storage.schema[d];m.type==="i32"?h[s]=y(u):m.type==="bool"?h[s]=u?1:0:h[s]=u;break}}if(this.entityComponents.set(r,l),a._init(r,n,l,this),t.x!==void 0||t.y!==void 0){let d=t.x??0,u=t.y??0;a.render.prevX=d,a.render.prevY=u,a.render.interpX=d,a.render.interpY=u}return this.queryEngine.addEntity(r,n,l,c),a}spawnWithId(e,t,n={}){let o;if(typeof e=="string")o=e;else{let u=e._getDefinition();this._registerEntityDef(u),o=u.name}let r=this.entityDefs.get(o);if(!r)throw new Error(`Unknown entity type: '${o}'`);let s=this.idAllocator.allocateSpecific(t),a=s&1048575,l=this.entityPool.acquire(s);this.activeEntities.add(s),this.entityTypes.set(s,o);let c=[];for(let u of r.components){let f=u.type;if(c.push(f),Se(f.storage,a),Je(f.storage,a),u.defaults)for(let[h,m]of Object.entries(u.defaults)){let g=f.storage.fields[h];if(g){let x=f.storage.schema[h];x.type==="i32"?g[a]=y(m):x.type==="bool"?g[a]=m?1:0:g[a]=m}}}let d;for(let[u,f]of Object.entries(n)){u==="clientId"&&(d=f,this.entityClientIds.set(s,d));for(let h of r.components){let m=h.type.storage.fields[u];if(m){let g=h.type.storage.schema[u];g.type==="i32"?m[a]=y(f):g.type==="bool"?m[a]=f?1:0:m[a]=f;break}}}if(this.entityComponents.set(s,c),l._init(s,o,c,this),n.x!==void 0||n.y!==void 0){let u=n.x??0,f=n.y??0;l.render.prevX=u,l.render.prevY=f,l.render.interpX=u,l.render.interpY=f}return this.queryEngine.addEntity(s,o,c,d),l}destroyEntity(e){let t=e.eid;if(!this.activeEntities.has(t))return;let n=this.entityTypes.get(t)||"",o=this.entityComponents.get(t)||[],r=this.entityClientIds.get(t),s=t&1048575;for(let a of o)Ae(a.storage,s);this.queryEngine.removeEntity(t,n,o,r),this.activeEntities.delete(t),this.entityTypes.delete(t),this.entityComponents.delete(t),this.entityClientIds.delete(t),this.entityPool.release(t),this.idAllocator.free(t)}getEntity(e){if(!this.activeEntities.has(e))return null;let t=this.entityPool.get(e);return t&&!t.destroyed?t:null}isDestroyed(e){return!this.activeEntities.has(e)}getEntityByClientId(e){let t=this.queryEngine.getByClientId(e);return t===void 0?null:this.getEntity(t)}setEntityClientId(e,t){this.entityClientIds.set(e,t),this.queryEngine.setClientId(e,t)}query(e,...t){return this.queryEngine.query(e,...t)}getAllEntities(){let e=[],t=Array.from(this.activeEntities).sort((n,o)=>n-o);for(let n of t){let o=this.entityPool.get(n);o&&e.push(o)}return e}getAllEntityIds(){return Array.from(this.activeEntities).sort((e,t)=>e-t)}addSystem(e,t){return this.scheduler.add(e,t)}runSystems(){this.scheduler.runAll()}internString(e,t){return this.strings.intern(e,t)}getString(e,t){return this.strings.getString(e,t)}setInput(e,t){this.inputRegistry.set(e,t);let n=this.getEntityByClientId(e);n&&n._setInputData(t)}getInput(e){return this.inputRegistry.get(e)}clearInputs(){this.inputRegistry.clear()}getInputState(){let e={};for(let[t,n]of this.inputRegistry)e[t]=n;return e}setInputState(e){this.inputRegistry.clear();for(let[t,n]of Object.entries(e)){let o=parseInt(t,10);this.inputRegistry.set(o,n);let r=this.getEntityByClientId(o);r&&r._setInputData(n)}}getState(){let e=[];for(let t of this.activeEntities){let n=this.entityTypes.get(t),o=this.entityComponents.get(t)||[],r=t&1048575,s={};for(let a of o){let l={};for(let[c,d]of Object.entries(a.storage.fields))l[c]=d[r];s[a.name]=l}e.push({eid:t,type:n,components:s,clientId:this.entityClientIds.get(t)})}return{entities:e,allocator:this.idAllocator.getState(),strings:this.strings.getState()}}setState(e){this.clear(),this.idAllocator.setState(e.allocator),this.strings.setState(e.strings);for(let t of e.entities){let n=this.entityDefs.get(t.type);if(!n){console.warn(`Unknown entity type in snapshot: ${t.type}`);continue}let o=t.eid,r=o&1048575,s=this.entityPool.acquire(o);this.activeEntities.add(o),this.entityTypes.set(o,t.type),t.clientId!==void 0&&this.entityClientIds.set(o,t.clientId);let a=[];for(let l of n.components){let c=l.type;a.push(c),Se(c.storage,r);let d=t.components[c.name];if(d)for(let[u,f]of Object.entries(d)){let h=c.storage.fields[u];h&&(h[r]=f)}}this.entityComponents.set(o,a),s._init(o,t.type,a,this),this.queryEngine.addEntity(o,t.type,a,t.clientId)}}clear(){for(let e of this.activeEntities){let t=this.entityComponents.get(e)||[],n=e&1048575;for(let o of t)Ae(o.storage,n);this.entityPool.release(e)}this.activeEntities.clear(),this.entityTypes.clear(),this.entityComponents.clear(),this.entityClientIds.clear(),this.queryEngine.clear(),this.idAllocator.reset(),this.strings.clear()}reset(){this.clear()}get entityCount(){return this.activeEntities.size}getSparseSnapshot(){return this.snapshotCodec.encode(Array.from(this.activeEntities),e=>this.entityTypes.get(e)||"",e=>this.entityClientIds.get(e),e=>this.entityComponents.get(e)||[],this.idAllocator.getState(),this.strings.getState(),this.frame,this.seq,Be())}loadSparseSnapshot(e){let t=new Map;for(let n of this.activeEntities){let o=this.entityPool.get(n);o&&t.set(n,{x:o.render.interpX,y:o.render.interpY})}this.snapshotCodec.decode(e,()=>this.clearForSnapshot(),n=>this.idAllocator.setState(n),n=>this.strings.setState(n),(n,o,r)=>this.createEntityFromSnapshot(n,o,r),n=>{n&&Re(n)}),this.frame=e.frame,this.seq=e.seq,this.syncRenderStateFromTransforms(t)}syncRenderStateFromTransforms(e){for(let t of this.activeEntities){let n=this.getEntity(t);if(!n)continue;let o=e.get(t);o&&(n.render.prevX=o.x,n.render.prevY=o.y);let r=this.entityComponents.get(t)||[],s=t&1048575;for(let a of r)if(a.name==="Transform2D"){let l=a.storage.fields.x,c=a.storage.fields.y;l&&c&&(n.render.interpX=l[s]/65536,n.render.interpY=c[s]/65536);break}}}clearForSnapshot(){for(let e of this.activeEntities){let t=this.entityComponents.get(e)||[],n=e&1048575;for(let o of t)Ae(o.storage,n);this.entityPool.release(e)}this.activeEntities.clear(),this.entityTypes.clear(),this.entityComponents.clear(),this.entityClientIds.clear(),this.queryEngine.clear()}createEntityFromSnapshot(e,t,n){let o=this.entityDefs.get(t);if(!o){console.warn(`Unknown entity type in snapshot: ${t}`);return}let r=e&1048575,s=this.entityPool.acquire(e);this.activeEntities.add(e),this.entityTypes.set(e,t),n!==void 0&&this.entityClientIds.set(e,n);let a=[];for(let l of o.components){let c=l.type;a.push(c),Se(c.storage,r)}this.entityComponents.set(e,a),s._init(e,t,a,this),this.queryEngine.addEntity(e,t,a,n)}snapshotToBinary(e){return this.snapshotCodec.toBinary(e)}snapshotFromBinary(e){return this.snapshotCodec.fromBinary(e)}getSnapshotSize(e){return this.snapshotCodec.getSize(e)}tick(e,t=[]){this.frame=e,this.applyNetworkInputs(t),this._isSimulating=!0;try{this.scheduler.runPhase("input"),this.scheduler.runPhase("update"),this.scheduler.runPhase("prePhysics"),this.scheduler.runPhase("physics"),this.scheduler.runPhase("postPhysics")}finally{this._isSimulating=!1}this._isClient&&this.scheduler.runPhase("render"),this.inputBuffer.clear()}applyNetworkInputs(e){for(let t of e){let n=this.getEntityByClientId(t.clientId);if(n){this.inputBuffer.set(t.clientId,t.data);let o=t.data;o&&n._setInputData(o)}}}getInputForClient(e){return this.inputBuffer.get(e)}hasInputForClient(e){return this.inputBuffer.has(e)}runPhysics(){this.scheduler.runPhase("physics")}setPhysicsStep(e){return this.addSystem(e,{phase:"physics",order:0})}saveInterpolationState(){for(let e of this.activeEntities){let t=this.getEntity(e);t&&t._savePreviousState()}}handleLocalInput(e){if(this.localClientId===null){console.warn("Cannot handle local input: localClientId not set");return}let t=this.getEntityByClientId(this.localClientId);t&&t._setInputData(e),this.inputHistory.setInput(this.frame,this.localClientId,e),this.predictions.push({frame:this.frame,input:e,hash:this.getStateHash()})}onServerTick(e,t){this.saveSnapshot(this.frame);let n=new Map;for(let s of t)n.set(s.clientId,s.data);this.inputHistory.confirmFrame(e,n);let o=e-120;o>0&&this.inputHistory.prune(o);let r=this.predictions.findIndex(s=>s.frame===e);if(r!==-1){let s=this.predictions[r],a=this.rollbackBuffer.get(e);a&&this.loadSparseSnapshot(a),this.tick(e,t);let c=this.getStateHash()!==s.hash;return c&&(this.onRollback?.(e),this.resimulateFrom(e)),this.predictions=this.predictions.filter(d=>d.frame>e),c}else return this.tick(e,t),!1}saveSnapshot(e){let t=this.getSparseSnapshot();this.rollbackBuffer.set(e,t);let n=e-this.rollbackBufferSize+1;for(let o of this.rollbackBuffer.keys())o<n&&this.rollbackBuffer.delete(o)}restoreSnapshot(e){let t=this.rollbackBuffer.get(e);return t?(this.loadSparseSnapshot(t),!0):!1}hasSnapshot(e){return this.rollbackBuffer.has(e)}getOldestSnapshotFrame(){let e;for(let t of this.rollbackBuffer.keys())(e===void 0||t<e)&&(e=t);return e}resimulateFrom(e){let t=this.frame,n=this.inputHistory.getRange(e+1,t);if(n.length>0)for(let o of n){let r=[];for(let[s,a]of o.getSortedInputs())r.push({clientId:s,data:a});this.tick(o.frame,r)}this.frame=t}getStateHash(){let e=Array.from(this.activeEntities).sort((n,o)=>n-o),t=0;for(let n of e){let o=n&1048575,r=this.entityComponents.get(n)||[];t=t*31+n|0;for(let s of r){if(!s.sync)continue;let a=[...s.fieldNames].sort();for(let l of a){let d=s.storage.fields[l][o];t=t*31+d|0}}}return(t>>>0).toString(16).padStart(8,"0")}clearRollbackBuffer(){this.rollbackBuffer.clear(),this.predictions=[]}getPendingPredictionCount(){return this.predictions.length}hasPendingPredictions(){return this.predictions.length>0}};var xn={};vt(xn,{decode:()=>Ce,encode:()=>Fe});var yn=class{constructor(){this.buffer=[]}writeByte(e){this.buffer.push(e&255)}writeUint16(e){this.buffer.push(e>>8&255),this.buffer.push(e&255)}writeUint32(e){this.buffer.push(e>>24&255),this.buffer.push(e>>16&255),this.buffer.push(e>>8&255),this.buffer.push(e&255)}writeInt32(e){this.writeUint32(e>>>0)}writeFloat64(e){let t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e,!1);for(let n=0;n<8;n++)this.buffer.push(t.getUint8(n))}writeString(e){let t=new TextEncoder().encode(e);this.writeUint16(t.length);for(let n=0;n<t.length;n++)this.buffer.push(t[n])}writeValue(e){if(e==null)this.writeByte(0);else if(e===!1)this.writeByte(1);else if(e===!0)this.writeByte(2);else if(typeof e=="number")Number.isInteger(e)?e>=0&&e<=255?(this.writeByte(10),this.writeByte(e)):e>=0&&e<=65535?(this.writeByte(11),this.writeUint16(e)):e>=-2147483648&&e<=2147483647?(this.writeByte(5),this.writeInt32(e)):(this.writeByte(6),this.writeFloat64(e)):(this.writeByte(6),this.writeFloat64(e));else if(typeof e=="string")this.writeByte(7),this.writeString(e);else if(Array.isArray(e)){this.writeByte(8),this.writeUint16(e.length);for(let t of e)this.writeValue(t)}else if(typeof e=="object"){this.writeByte(9);let t=Object.keys(e);this.writeUint16(t.length);for(let n of t)this.writeString(n),this.writeValue(e[n])}else this.writeByte(0)}toUint8Array(){return new Uint8Array(this.buffer)}},gn=class{constructor(e){this.pos=0;this.data=e}readByte(){return this.data[this.pos++]}readUint16(){let e=this.data[this.pos++],t=this.data[this.pos++];return e<<8|t}readUint32(){let e=this.data[this.pos++],t=this.data[this.pos++],n=this.data[this.pos++],o=this.data[this.pos++];return(e<<24|t<<16|n<<8|o)>>>0}readInt32(){let e=this.readUint32();return e>2147483647?e-4294967296:e}readFloat64(){let e=new DataView(new ArrayBuffer(8));for(let t=0;t<8;t++)e.setUint8(t,this.data[this.pos++]);return e.getFloat64(0,!1)}readString(){let e=this.readUint16(),t=this.data.slice(this.pos,this.pos+e);return this.pos+=e,new TextDecoder().decode(t)}readValue(){switch(this.readByte()){case 0:return null;case 1:return!1;case 2:return!0;case 10:return this.readByte();case 11:return this.readUint16();case 5:return this.readInt32();case 12:return this.readUint32();case 6:return this.readFloat64();case 7:return this.readString();case 8:{let t=this.readUint16(),n=[];for(let o=0;o<t;o++)n.push(this.readValue());return n}case 9:{let t=this.readUint16(),n={};for(let o=0;o<t;o++){let r=this.readString();n[r]=this.readValue()}return n}default:return null}}};function Fe(i){let e=new yn;return e.writeValue(i),e.toUint8Array()}function Ce(i){return new gn(i).readValue()}var O=!1,st=class{constructor(e,t,n){this.game=e;this.typeName=t;this.builder=n}spawn(e={}){return this.game.spawn(this.typeName,e)}},at=class{constructor(){this.physics=null;this.connection=null;this.callbacks={};this.connectedRoomId=null;this.localClientIdStr=null;this.connectedClients=[];this.authorityClientId=null;this.currentFrame=0;this.lastProcessedFrame=0;this.lastInputSeq=0;this.serverFps=20;this.gameLoop=null;this.pendingSnapshotUpload=!1;this.lastSnapshotHash=null;this.lastSnapshotFrame=0;this.lastSnapshotSize=0;this.lastSnapshotEntityCount=0;this.driftStats={determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0};this.lastSyncPercent=100;this.firstDivergenceFrame=null;this.divergenceHistory=[];this.recentInputs=[];this.lastServerSnapshot={raw:null,decoded:null,frame:0};this.lastGoodSnapshot=null;this.divergenceCaptured=!1;this.divergenceCapture=null;this.lastTickTime=0;this.tickIntervalMs=50;this.clientIdToNum=new Map;this.numToClientId=new Map;this.nextClientNum=1;this.prefabs=new Map;this.collisionHandlers=new Map;this.clientsWithEntitiesFromSnapshot=new Set;this.renderer=null;this.plugins=new Map;this.world=new Ne}addPlugin(e,...t){let n=new e(this,...t),o=e.name||"anonymous";return this.plugins.set(o,n),n}getPlugin(e){return this.plugins.get(e.name)}get frame(){return this.currentFrame}get time(){return this.currentFrame*this.tickIntervalMs}defineEntity(e){return new vn(this,e)}_registerPrefab(e,t){let n=new st(this,e,t);return this.prefabs.set(e,n),n}spawn(e,t={}){let n={...t};return t.clientId&&typeof t.clientId=="string"&&(n.clientId=this.internClientId(t.clientId)),this.world.spawn(e,n)}getPrefab(e){return this.prefabs.get(e)}query(e){return this.world.query(e)}getEntitiesByType(e){return this.world.query(e).toArray()}getAllEntities(){return this.world.getAllEntities()}getEntityByClientId(e){let t=this.clientIdToNum.get(e);return t===void 0?null:this.world.getEntityByClientId(t)}getPlayer(e){return this.getEntityByClientId(e)}getPlayers(){return this.world.query(ie).toArray()}addSystem(e,t){return this.world.addSystem(e,t)}onCollision(e,t,n){if(this.physics)this.physics.onCollision(e,t,n);else{let o=`${e}:${t}`;this.collisionHandlers.set(o,n)}return this}internClientId(e){let t=this.clientIdToNum.get(e);return t===void 0&&(t=this.nextClientNum++,this.clientIdToNum.set(e,t),this.numToClientId.set(t,e)),t}getClientIdString(e){return this.numToClientId.get(e)}internString(e,t){return this.world.internString(e,t)}getString(e,t){return this.world.getString(e,t)}getStateHash(){return this.world.getStateHash()}reset(){this.world.reset(),this.currentFrame=0}async connect(e,t,n={}){if(this.callbacks=t,typeof window<"u"){let r=new URLSearchParams(window.location.search);r.get("room")&&(e=r.get("room")),r.get("nodeUrl")&&(n.nodeUrl=r.get("nodeUrl"))}this.connectedRoomId=e;let o=window.moduNetwork;if(!o)throw new Error("moduNetwork not found. Include modu-network SDK before calling connect().");console.log(`[ecs] Connecting to room "${e}"...`);try{this.connection=await o.connect(e,{nodeUrl:n.nodeUrl,centralServiceUrl:n.centralServiceUrl,appId:"dev",joinToken:n.joinToken,onConnect:(r,s,a,l,c,d)=>{this.handleConnect(r,s,a,c,d)},onTick:(r,s)=>{this.handleTick(r,s)},onDisconnect:()=>{this.handleDisconnect()},onBinarySnapshot:r=>{this.handleServerSnapshot(r)},onError:r=>{console.error("[ecs] Network error:",r)}}),this.localClientIdStr=this.connection.clientId}catch(r){console.warn("[ecs] Connection failed:",r?.message||r),this.connection=null,this.connectedRoomId=null}}handleConnect(e,t,n,o,r){let s=0;if(e instanceof Uint8Array)if(s=e.length,e.length<2)e=null;else try{e=Ce(e)?.snapshot||null}catch(l){console.error("[ecs] Failed to decode snapshot:",l),e=null}if(this.localClientIdStr=r,this.serverFps=o,this.tickIntervalMs=1e3/o,this.currentFrame=n,e?.hash!==void 0&&(this.lastSnapshotHash=typeof e.hash=="number"?e.hash.toString(16).padStart(8,"0"):String(e.hash),this.lastSnapshotFrame=e.frame||n,this.lastSnapshotSize=s,this.lastSnapshotEntityCount=e.entities?.length||0),O&&(console.log(`[ecs] Connected as ${r}, frame ${n}, fps ${o}`),console.log("[ecs] Snapshot:",e?{frame:e.frame,entityCount:e.entities?.length}:"none"),console.log(`[ecs] Inputs: ${t.length}`)),e?.entities&&e.entities.length>0){O&&console.log(`[ecs] Late join: restoring snapshot frame=${e.frame}`),this.currentFrame=e.frame||n,this.loadNetworkSnapshot(e);for(let m of t)this.processAuthorityChainInput(m);this.callbacks.onSnapshot&&this.callbacks.onSnapshot(this.world.getAllEntities());let l=e.seq||0,c=t.filter(m=>m.seq>l).sort((m,g)=>m.seq-g.seq),d=this.currentFrame,f=e.postTick===!0?d+1:d,h=n-f+1;O&&console.log(`[ecs] Catchup: from ${f} to ${n} (${h} ticks), ${c.length} pending inputs`),h>0&&this.runCatchup(f,n,c),this.lastGoodSnapshot={snapshot:JSON.parse(JSON.stringify(e)),frame:this.currentFrame,hash:this.getStateHash()}}else{O&&console.log("[ecs] First join: creating room"),this.currentFrame=n,this.callbacks.onRoomCreate?.();for(let l of t)this.processInput(l)}this.checkIsAuthority()&&this.sendSnapshot("init"),this.startGameLoop(),O&&console.log("[ecs] Game loop started")}handleTick(e,t){if(e<=this.lastProcessedFrame){O&&console.log(`[ecs] Skipping old frame ${e} (already at ${this.lastProcessedFrame})`);return}if(this.currentFrame=e,this.lastProcessedFrame=e,O&&t.length>0){let o=t.map(r=>r.data?.type||"game").join(",");console.log(`[ecs] onTick frame=${e}: ${t.length} inputs (${o})`)}let n=t.length>1?[...t].sort((o,r)=>(o.seq||0)-(r.seq||0)):t;for(let o of n)this.processInput(o);this.world.tick(e,[]),this.callbacks.onTick?.(e),this.pendingSnapshotUpload&&this.checkIsAuthority()&&(this.sendSnapshot("join"),this.pendingSnapshotUpload=!1),this.lastTickTime=typeof performance<"u"?performance.now():Date.now()}processInput(e){let t=e.data;if(t instanceof Uint8Array)try{t=Ce(t)}catch(r){console.warn("[ecs] Failed to decode input:",r);return}let n=t?.clientId||e.clientId,o=t?.type;if(this.recentInputs.push({frame:this.currentFrame,seq:e.seq,clientId:n,data:JSON.parse(JSON.stringify(t))}),this.recentInputs.length>500&&this.recentInputs.shift(),e.seq>this.lastInputSeq&&(this.lastInputSeq=e.seq),o==="join")this.connectedClients.includes(n)||this.connectedClients.push(n),this.authorityClientId===null&&(this.authorityClientId=n),O&&console.log(`[ecs] Join: ${n.slice(0,8)}, authority=${this.authorityClientId?.slice(0,8)}`),this.clientsWithEntitiesFromSnapshot.has(n)?O&&console.log(`[ecs] Skipping onConnect for ${n.slice(0,8)} - already has entity from snapshot`):this.callbacks.onConnect?.(n),this.checkIsAuthority()&&(this.pendingSnapshotUpload=!0);else if(o==="leave"||o==="disconnect"){let r=this.connectedClients.indexOf(n);r!==-1&&this.connectedClients.splice(r,1),n===this.authorityClientId&&(this.authorityClientId=this.connectedClients[0]||null),O&&console.log(`[ecs] Leave: ${n.slice(0,8)}, new authority=${this.authorityClientId?.slice(0,8)}`),this.callbacks.onDisconnect?.(n)}else t&&this.routeInputToEntity(n,t)}routeInputToEntity(e,t){let n=this.internClientId(e),o=this.world.getEntityByClientId(n);O&&console.log(`[ecs] routeInput: clientId=${e.slice(0,8)}, numId=${n}, entity=${o?.eid||"null"}, data=${JSON.stringify(t)}`),o?this.world.setInput(n,t):O&&console.log(`[ecs] WARNING: No entity for clientId ${e.slice(0,8)} (numId=${n})`)}processAuthorityChainInput(e){let t=e.data;if(t instanceof Uint8Array)try{t=Ce(t)}catch{return}let n=t?.clientId||e.clientId,o=t?.type;if(o==="join")this.connectedClients.includes(n)||this.connectedClients.push(n),this.authorityClientId===null&&(this.authorityClientId=n);else if(o==="leave"||o==="disconnect"){let r=this.connectedClients.indexOf(n);r!==-1&&this.connectedClients.splice(r,1),n===this.authorityClientId&&(this.authorityClientId=this.connectedClients[0]||null)}}runCatchup(e,t,n){let o=t-e+1;O&&console.log(`[ecs] Catchup: ${o} ticks from ${e} to ${t}, ${n.length} inputs`);let r=[...n].sort((a,l)=>(a.seq||0)-(l.seq||0)),s=new Map;for(let a of r){let l=a.frame??e;s.has(l)||s.set(l,[]),s.get(l).push(a)}for(let a=0;a<o;a++){let l=e+a;this.currentFrame=l;let c=s.get(l)||[];for(let d of c)this.processInput(d);this.world.tick(l,[]),this.callbacks.onTick?.(l)}this.currentFrame=t,this.lastProcessedFrame=t,this.clientsWithEntitiesFromSnapshot.clear(),O&&console.log(`[ecs] Catchup complete at frame ${this.currentFrame}, hash=${this.getStateHash()}`)}getNetworkSnapshot(){let e=[],t=new Map,n=[],o=new Map,r=[];for(let l of this.world.getAllEntities()){let c=l.eid&1048575,d=l.type;if(!t.has(d)){let h=e.length;e.push(d),t.set(d,h);let m=this.world.getEntityDef(d),g=m?.syncFields?new Set(m.syncFields):null;o.set(d,g);let x=[];for(let F of l.getComponents()){let C=g?F.fieldNames.filter(w=>g.has(w)):F.fieldNames;C.length>0&&x.push([F.name,C])}n.push(x)}let u=o.get(d),f=[];for(let h of l.getComponents())for(let m of h.fieldNames)(!u||u.has(m))&&f.push(h.storage.fields[m][c]);r.push([l.eid,t.get(d),f])}let s=0,a={};for(let l of r){let c=l[0],d=c&1048575,u=c>>>20;d>=s&&(s=d+1),a[d]=u}return{frame:this.currentFrame,seq:this.lastInputSeq,format:5,types:e,schema:n,entities:r,idAllocatorState:{nextIndex:s,freeList:[],generations:a},rng:Be(),strings:this.world.strings.getState(),clientIdMap:{toNum:Object.fromEntries(this.clientIdToNum),nextNum:this.nextClientNum},inputState:this.world.getInputState()}}loadNetworkSnapshot(e){O&&console.log(`[ecs] Loading snapshot: ${e.entities?.length} entities`),this.world.reset(),this.physics&&this.physics.clear(),e.rng&&Re(e.rng),e.strings&&this.world.strings.setState(e.strings),e.clientIdMap&&(this.clientIdToNum=new Map(Object.entries(e.clientIdMap.toNum).map(([s,a])=>[s,a])),this.numToClientId=new Map(Array.from(this.clientIdToNum.entries()).map(([s,a])=>[a,s])),this.nextClientNum=e.clientIdMap.nextNum||1);let t=e.types,n=e.schema,o=e.entities,r=new Map;for(let s of o){let[a,l,c]=s,d=t[l],u=n[l],f;try{f=this.world.spawnWithId(d,a,{})}catch(g){console.warn(`[ecs] Failed to spawn ${d} with eid ${a}:`,g);continue}r.has(d)||r.set(d,[]),r.get(d).push(f);let h=a&1048575,m=0;for(let[g,x]of u)for(let F of f.getComponents())if(F.name===g){for(let C of x)F.storage.fields[C][h]=c[m++];break}if(f.has(ie)){let g=f.get(ie);g.clientId!==0&&this.world.setEntityClientId(f.eid,g.clientId)}}for(let[s,a]of r){let l=this.world.getEntityDef(s);if(l?.onRestore)for(let c of a)l.onRestore(c,this)}if(this.lastInputSeq=e.seq||0,e.idAllocatorState){let s=e.idAllocatorState;if(e.format>=3&&typeof s.generations=="object"&&!Array.isArray(s.generations)){this.world.idAllocator.reset(),this.world.idAllocator.setNextId(s.nextIndex);for(let[l,c]of Object.entries(s.generations)){let d=parseInt(l,10);this.world.idAllocator.generations[d]=c}let a=[];for(let l=0;l<s.nextIndex;l++)l.toString()in s.generations||a.push(l);this.world.idAllocator.freeList=a}else this.world.idAllocator.setState(s)}this.clientsWithEntitiesFromSnapshot.clear();for(let s of this.world.query(ie)){let a=s.get(ie);if(a.clientId!==0){let l=this.getClientIdString(a.clientId);l&&(this.clientsWithEntitiesFromSnapshot.add(l),O&&console.log(`[ecs] Snapshot has entity for client ${l.slice(0,8)}`))}}if(this.physics&&this.physics.wakeAllBodies(),e.inputState&&this.world.setInputState(e.inputState),O){console.log(`[ecs] Snapshot loaded: ${this.world.getAllEntities().length} entities, hash=${this.getStateHash()}`);let s=this.world.getAllEntities()[0];if(s){let a={};for(let l of s.getComponents()){let c={};for(let d of l.fieldNames)c[d]=s.get(l)[d];a[l.name]=c}console.log(`[ecs] Restored first entity: type=${s.type}, components=`,JSON.stringify(a))}}}sendSnapshot(e){if(!this.connection)return;this.physics&&this.physics.wakeAllBodies();let t=this.getNetworkSnapshot(),n=this.world.getStateHash(),o=Fe({snapshot:t,hash:n}),r=Fe(t.entities).length,s=Fe(t.schema).length,a=t.entities.length;console.log(`[SNAPSHOT-SIZE] Total: ${o.length}B | entities: ${r}B (${a}) | schema: ${s}B`),O&&console.log(`[ecs] Sending snapshot (${e}): ${o.length} bytes, ${a} entities, hash=${n}`),this.connection.sendSnapshot(o,n,t.seq,t.frame),this.lastSnapshotHash=n,this.lastSnapshotFrame=t.frame,this.lastSnapshotSize=o.length,this.lastSnapshotEntityCount=a}handleServerSnapshot(e){O&&console.log(`[ecs] Received server snapshot: ${e.length} bytes`);try{let t=Ce(e),n=t?.snapshot,o=t?.hash;if(n)if(this.lastSnapshotHash=o,this.lastSnapshotFrame=n.frame,this.lastSnapshotSize=e.length,this.lastSnapshotEntityCount=n.entities?.length||0,this.currentFrame===n.frame){this.compareSnapshotFields(n);let r=this.getStateHash();r!==o&&console.warn(`[ecs] DRIFT detected at frame ${n.frame}: local=${r}, server=${o}`)}else this.driftStats={determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0}}catch(t){console.warn("[ecs] Failed to decode server snapshot:",t)}}compareSnapshotFields(e){let t=e.frame,n=0,o=0,r=[];this.lastServerSnapshot={raw:null,decoded:e,frame:t};let s=e.types||[],a=e.entities||[],l=e.schema||[],c=new Map;for(let h of a)c.set(h[0],h);for(let h of this.world.getAllEntities()){let m=h.eid,g=c.get(m),x=m&1048575;if(!g){for(let B of h.getComponents()){o+=B.fieldNames.length;for(let R of B.fieldNames)r.push({entity:h.type,eid:m,comp:B.name,field:R,local:"EXISTS",server:"MISSING"})}continue}let[,F,C]=g,w=l[F];if(!w)continue;let U=0;for(let[B,R]of w){let Y=h.getComponents().find(L=>L.name===B);for(let L of R){o++;let X=C[U++];if(Y){let H=Y.storage.fields[L][x],le=Y.schema[L],I=!1;le?.type==="bool"?I=H!==0===(X!==0&&X!==!1):I=H===X,I?n++:r.push({entity:h.type,eid:m,comp:B,field:L,local:H,server:X})}}}}for(let[h,m]of c)if(this.world.getEntity(h)===null){let[,g,x]=m,F=s[g]||`type${g}`;o+=x.length,r.push({entity:F,eid:h,comp:"*",field:"*",local:"MISSING",server:"EXISTS"})}let d=o>0?n/o*100:100,u=this.lastSyncPercent===100,f=d===100;if(f&&(this.lastGoodSnapshot={snapshot:JSON.parse(JSON.stringify(e)),frame:t,hash:this.getStateHash()}),u&&!f&&!this.divergenceCaptured){this.firstDivergenceFrame=t,this.divergenceHistory=[],this.divergenceCaptured=!0;let h=this.lastGoodSnapshot?.frame??0,m=this.recentInputs.filter(x=>x.frame>h&&x.frame<=t),g=this.world.getState();this.divergenceCapture={lastGoodSnapshot:this.lastGoodSnapshot?.snapshot??null,lastGoodFrame:h,inputs:m,localSnapshot:g,serverSnapshot:e,diffs:r,divergenceFrame:t,clientId:this.localClientIdStr,isAuthority:this.checkIsAuthority()},this.showDivergenceDiff(r,m,t)}this.lastSyncPercent=d,this.driftStats.totalChecks++,this.driftStats.matchingFieldCount=n,this.driftStats.totalFieldCount=o,this.driftStats.determinismPercent=d,r.length>0&&d<100&&this.divergenceCaptured&&t%60===0&&console.warn(`[DIVERGENCE] Frame ${t}: still diverged (${d.toFixed(1)}% sync, first at ${this.firstDivergenceFrame})`)}showDivergenceDiff(e,t,n){let o=[],r=this.lastGoodSnapshot?.frame??0,s=this.localClientIdStr||"",a=new Set;for(let u of t)a.add(u.clientId);let l=Array.from(a),c=new Map;l.forEach((u,f)=>{let h=u===s?"ME":`P${f+1}`;c.set(u,h)});let d=new Map;for(let u of this.world.getAllEntities())if(u.has(ie)){let f=u.get(ie),h=this.numToClientId.get(f.clientId);h&&d.set(u.eid,c.get(h)||h.slice(0,8))}o.push("=== DIVERGENCE DEBUG DATA ==="),o.push(`Frame: ${n} | Last good: ${r} | Authority: ${this.checkIsAuthority()}`),o.push(`Clients: ${l.map(u=>`${c.get(u)}=${u.slice(0,8)}`).join(", ")}`),o.push(""),o.push(`DIVERGENT FIELDS (${e.length}):`);for(let u of e){let f=typeof u.local=="number"&&typeof u.server=="number"?` \u0394${u.local-u.server}`:"",h=d.get(u.eid),m=h?` [${h}]`:"";o.push(`  ${u.entity}#${u.eid.toString(16)}${m}.${u.comp}.${u.field}: local=${u.local} server=${u.server}${f}`)}o.push(""),o.push(`INPUTS (${t.length}):`);for(let u of t){let f=c.get(u.clientId)||u.clientId.slice(0,8);o.push(`  f${u.frame} [${f}]: ${JSON.stringify(u.data)}`)}if(o.push(""),this.lastGoodSnapshot){let u=Object.keys(this.lastGoodSnapshot.snapshot.entities||{}).length;o.push(`LAST GOOD SNAPSHOT (f${r}): ${u} entities`)}else o.push("LAST GOOD SNAPSHOT: none (never had 100% sync)");if(this.lastServerSnapshot.decoded){let u=Object.keys(this.lastServerSnapshot.decoded.entities||{}).length;o.push(`SERVER SNAPSHOT (f${this.lastServerSnapshot.frame}): ${u} entities`)}o.push("=== END DEBUG DATA ==="),o.push("To get detailed replay data: game.getDivergenceReplay()"),console.error(o.join(`
`))}getDivergenceReplay(){if(!this.divergenceCapture){console.warn("[REPLAY] No divergence captured yet.");return}let e=JSON.stringify(this.divergenceCapture,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`divergence-${this.divergenceCapture.divergenceFrame}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),console.log(`[REPLAY] Downloaded (${(e.length/1024).toFixed(1)} KB)`)}startGameLoop(){if(this.gameLoop)return;let e=0,n=typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?10:100,o=()=>{this.renderer?.render?this.renderer.render():this.callbacks.render&&this.callbacks.render(),this.checkIsAuthority()&&this.currentFrame-e>=n&&(this.sendSnapshot("loop"),e=this.currentFrame),this.gameLoop=requestAnimationFrame(o)};this.gameLoop=requestAnimationFrame(o)}stopGameLoop(){this.gameLoop&&(cancelAnimationFrame(this.gameLoop),this.gameLoop=null)}handleDisconnect(){O&&console.log("[ecs] Disconnected"),this.stopGameLoop()}checkIsAuthority(){if(this.localClientIdStr===null||this.authorityClientId===null)return!1;let e=Math.min(this.localClientIdStr.length,this.authorityClientId.length);return this.localClientIdStr.substring(0,e)===this.authorityClientId.substring(0,e)}isAuthority(){return this.checkIsAuthority()}isConnected(){return this.connection!==null}getFrame(){return this.currentFrame}getServerFps(){return this.serverFps}getRenderAlpha(){if(this.lastTickTime===0)return 1;let t=(typeof performance<"u"?performance.now():Date.now())-this.lastTickTime;return Math.min(t/this.tickIntervalMs,1)}sendInput(e){if(!this.connection)return;let t=Fe(e);this.connection.send(t)}leaveRoom(){this.connection&&(this.connection.leaveRoom(),this.connection=null,this.stopGameLoop())}get localClientId(){return this.localClientIdStr}setLocalClientId(e){this.localClientIdStr=e;let t=this.internClientId(e);this.world.localClientId=t}getRoomId(){return this.connectedRoomId}getLastSnapshot(){return{hash:this.lastSnapshotHash,frame:this.lastSnapshotFrame,size:this.lastSnapshotSize,entityCount:this.lastSnapshotEntityCount}}getClients(){return this.connectedClients}getClientId(){return this.localClientIdStr}getNodeUrl(){return null}getUploadRate(){return this.connection?.bandwidthOut||0}getDownloadRate(){return this.connection?.bandwidthIn||0}getDriftStats(){if(this.driftStats.totalChecks===0){let e=this.world.getAllEntities().length,t=0;for(let n of this.world.getAllEntities())for(let o of n.getComponents())t+=o.fieldNames.length;return{determinismPercent:100,totalChecks:0,matchingFieldCount:t,totalFieldCount:t}}return{...this.driftStats}}setRenderer(e){this.renderer=e}getCanvas(){return this.renderer?.element??null}},vn=class{constructor(e,t){this.game=e;this.name=t;this.inputCommandsDef=null;this.worldBuilder=e.world.defineEntity(t)}with(e,t){return this.worldBuilder.with(e,t),this}commands(e){return this.inputCommandsDef=e,this}syncOnly(e){return this.worldBuilder._setSyncFields(e),this}syncNone(){return this.worldBuilder._setSyncFields([]),this}sync(e){return this.syncOnly(e)}onRestore(e){return this.worldBuilder._setOnRestore(e),this}register(){return this.worldBuilder._ensureRegistered(),this.game._registerPrefab(this.name,this.worldBuilder)}};function di(){return new at}var lt=class{constructor(e,t,n={}){this.imageCache=new Map;this._cameraEntity=null;if(this.game=e,typeof t=="string"){let r=document.querySelector(t);if(!r)throw new Error(`Canvas not found: ${t}`);this.canvas=r}else this.canvas=t;let o=this.canvas.getContext("2d");if(!o)throw new Error("Could not get 2d context");this.ctx=o,this.options={background:n.background??"#111",autoClear:n.autoClear??!0},e.setRenderer(this)}get width(){return this.canvas.width}get height(){return this.canvas.height}get element(){return this.canvas}get context(){return this.ctx}set camera(e){if(this._cameraEntity=e,e)try{let t=e.get(Q);t.viewportWidth=this.canvas.width,t.viewportHeight=this.canvas.height}catch{}}get camera(){return this._cameraEntity}render(){let{ctx:e,canvas:t,options:n,game:o}=this;n.autoClear&&(e.fillStyle=n.background,e.fillRect(0,0,t.width,t.height));let r=o.getRenderAlpha(),s=0,a=0,l=1;if(this._cameraEntity&&!this._cameraEntity.destroyed)try{let d=this._cameraEntity.get(Q);s=d.x,a=d.y,l=d.zoom,d.viewportWidth=t.width,d.viewportHeight=t.height}catch{}let c=[];for(let d of o.getAllEntities())if(!d.destroyed)try{let u=d.get(et);u&&u.visible&&(d.interpolate(r),c.push({entity:d,layer:u.layer}))}catch{}c.sort((d,u)=>d.layer-u.layer),e.save(),e.translate(t.width/2,t.height/2),e.scale(l,l),e.translate(-s,-a);for(let{entity:d}of c)this.drawEntity(d);e.restore()}drawEntity(e){let{ctx:t,game:n}=this,o=e.get(et),r=e.render.interpX+o.offsetX,s=e.render.interpY+o.offsetY,a=o.scaleX,l=o.scaleY,c=n.getString("color",o.color)||"#fff";t.save(),t.translate(r,s),t.scale(a,l);let d=o.shape;if(d===Me){let u=o.radius;t.fillStyle=c,t.beginPath(),t.arc(0,0,u,0,Math.PI*2),t.fill()}else if(d===Mt){let u=o.width,f=o.height;t.fillStyle=c,t.fillRect(-u/2,-f/2,u,f)}else if(d===kt){let u=n.getString("sprite",o.spriteId);if(u){let f=this.getImage(u);if(f&&f.complete){let h=o.width||f.width,m=o.height||f.height;t.drawImage(f,-h/2,-m/2,h,m)}}}t.restore()}getImage(e){let t=this.imageCache.get(e);return t||(t=new Image,t.src=e,this.imageCache.set(e,t)),t}preload(e){return Promise.all(e.map(t=>new Promise(n=>{let o=this.getImage(t);o?.complete?n():o&&(o.onload=()=>n(),o.onerror=()=>n())}))).then(()=>{})}};var Nt=class{constructor(e,t){this.actions=new Map;this.bindings=new Map;this.mousePos={x:0,y:0};this.keysDown=new Set;this.mouseButtons=new Set;this.sendInterval=null;this.lastSentInput="";if(this.game=e,typeof t=="string"){let n=document.querySelector(t);if(!n)throw new Error(`Canvas not found: ${t}`);this.canvas=n}else this.canvas=t;this.setupListeners(),this.startSendLoop()}action(e,t){return this.actions.set(e,t),this.bindings.has(e)||this.bindings.set(e,[...t.bindings]),this}rebind(e,t){return this.actions.has(e)?(this.bindings.set(e,t),this):(console.warn(`[InputPlugin] Unknown action: ${e}`),this)}resetBinding(e){let t=this.actions.get(e);return t&&this.bindings.set(e,[...t.bindings]),this}resetAllBindings(){for(let[e,t]of this.actions)this.bindings.set(e,[...t.bindings]);return this}getBindings(){let e={};for(let[t,n]of this.bindings)e[t]=n.filter(o=>typeof o=="string");return e}loadBindings(e){for(let[t,n]of Object.entries(e))this.actions.has(t)&&this.bindings.set(t,n);return this}get(e){let t=this.actions.get(e),n=this.bindings.get(e);return!t||!n?null:t.type==="button"?this.resolveButton(n):this.resolveVector(n)}getAll(){let e={};for(let t of this.actions.keys())e[t]=this.get(t);return e}resolveButton(e){for(let t of e)if(typeof t=="function"){if(t())return!0}else if(this.resolveStringButton(t))return!0;return!1}resolveVector(e){let t=0,n=0;for(let o of e){let r=null;typeof o=="function"?r=o():r=this.resolveStringVector(o),r&&(t+=r.x,n+=r.y)}if(Math.abs(t)<=1&&Math.abs(n)<=1){let o=Math.sqrt(t*t+n*n);o>1&&(t/=o,n/=o)}return{x:t,y:n}}resolveStringButton(e){if(e.startsWith("key:")){let t=e.slice(4).toLowerCase();return this.keysDown.has(t)}if(e.startsWith("mouse:")){let t=e.slice(6);if(t==="left")return this.mouseButtons.has(0);if(t==="right")return this.mouseButtons.has(2);if(t==="middle")return this.mouseButtons.has(1)}return!1}resolveStringVector(e){if(e==="mouse")return{...this.mousePos};if(e==="keys:wasd")return this.getWASD();if(e==="keys:arrows")return this.getArrows();if(e==="keys:wasd+arrows"){let t=this.getWASD(),n=this.getArrows();return{x:Math.max(-1,Math.min(1,t.x+n.x)),y:Math.max(-1,Math.min(1,t.y+n.y))}}return null}getWASD(){let e=0,t=0;return this.keysDown.has("a")&&(e-=1),this.keysDown.has("d")&&(e+=1),this.keysDown.has("w")&&(t-=1),this.keysDown.has("s")&&(t+=1),{x:e,y:t}}getArrows(){let e=0,t=0;return this.keysDown.has("arrowleft")&&(e-=1),this.keysDown.has("arrowright")&&(e+=1),this.keysDown.has("arrowup")&&(t-=1),this.keysDown.has("arrowdown")&&(t+=1),{x:e,y:t}}setupListeners(){this.canvas.addEventListener("mousemove",e=>{let t=this.canvas.getBoundingClientRect();this.mousePos.x=e.clientX-t.left,this.mousePos.y=e.clientY-t.top}),this.canvas.addEventListener("mousedown",e=>{this.mouseButtons.add(e.button)}),this.canvas.addEventListener("mouseup",e=>{this.mouseButtons.delete(e.button)}),window.addEventListener("keydown",e=>{this.keysDown.add(e.key.toLowerCase())}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key.toLowerCase())}),window.addEventListener("blur",()=>{this.keysDown.clear(),this.mouseButtons.clear()})}startSendLoop(){let e=1e3/(this.game.getServerFps?.()||20);this.sendInterval=window.setInterval(()=>{if(this.game.isConnected()&&this.game.localClientId&&this.actions.size>0){let t=this.getAll(),n=this.inputToString(t);n!==this.lastSentInput&&(this.lastSentInput=n,this.game.sendInput(t))}},e)}inputToString(e){let t={};for(let[n,o]of Object.entries(e))o&&typeof o=="object"&&"x"in o&&"y"in o?t[n]={x:Math.round(o.x/10)*10,y:Math.round(o.y/10)*10}:t[n]=o;return JSON.stringify(t)}destroy(){this.sendInterval!==null&&(clearInterval(this.sendInterval),this.sendInterval=null)}};var Lt=class{constructor(e,t={}){this.game=e,this.options={defaultZoom:t.defaultZoom??1,defaultSmoothing:t.defaultSmoothing??.1,minZoom:t.minZoom??.1,maxZoom:t.maxZoom??10},e.addSystem(this.update.bind(this),{phase:"render"})}update(){for(let e of this.game.query("Camera2D"))this.updateCamera(e)}updateCamera(e){let t=e.get(Q);if(t.followEntity!==0){let n=this.game.world.getEntity(t.followEntity);if(n&&!n.destroyed)try{let o=n.get($);t.x+=(o.x-t.x)*t.smoothing,t.y+=(o.y-t.y)*t.smoothing}catch{}}t.zoom!==t.targetZoom&&(t.zoom+=(t.targetZoom-t.zoom)*t.smoothing,t.zoom=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,t.zoom)))}follow(e,t){let n=e.get(Q);n.followEntity=t?t.eid:0}centerOn(e,t,n){if(t.length===0)return;let o=e.get(Q),r=0,s=0,a=0;for(let l=0;l<t.length;l++){let c=t[l];if(!c.destroyed)try{let d=c.get($),u=n?.[l]??1;s+=d.x*u,a+=d.y*u,r+=u}catch{}}r>0&&(o.x+=(s/r-o.x)*o.smoothing,o.y+=(a/r-o.y)*o.smoothing)}worldToScreen(e,t,n){let o=e.get(Q);return{x:(t-o.x)*o.zoom+o.viewportWidth/2,y:(n-o.y)*o.zoom+o.viewportHeight/2}}screenToWorld(e,t,n){let o=e.get(Q);return{x:(t-o.viewportWidth/2)/o.zoom+o.x,y:(n-o.viewportHeight/2)/o.zoom+o.y}}setZoom(e,t,n=!1){let o=e.get(Q),r=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,t));o.targetZoom=r,n&&(o.zoom=r)}getVisibleBounds(e){let t=e.get(Q),n=t.viewportWidth/2/t.zoom,o=t.viewportHeight/2/t.zoom;return{left:t.x-n,top:t.y-o,right:t.x+n,bottom:t.y+o}}isPointVisible(e,t,n,o=0){let r=this.getVisibleBounds(e);return t>=r.left-o&&t<=r.right+o&&n>=r.top-o&&n<=r.bottom+o}};var q={},Yt=null,Ut=new Set;function zt(){return Yt?.world?._isSimulating??!1}function Ot(i,e){Ut.has(i)||(Ut.add(i),console.warn(e))}function qt(i){if(Yt){console.warn("Determinism guard already installed for another game instance");return}Yt=i,Ut.clear(),q.mathRandom=Math.random,Math.random=function(){return zt()&&Ot("Math.random",`\u26A0\uFE0F Math.random() is non-deterministic!
   Use dRandom() instead for deterministic random numbers.
   Example: const r = dRandom();`),q.mathRandom()},q.mathSqrt=Math.sqrt,Math.sqrt=function(e){return zt()&&Ot("Math.sqrt",`\u26A0\uFE0F Math.sqrt() is non-deterministic!
   Use dSqrt() instead for deterministic square root.
   Example: const dist = dSqrt(dx * dx + dy * dy);`),q.mathSqrt(e)},q.dateNow=Date.now,Date.now=function(){return zt()&&Ot("Date.now",`\u26A0\uFE0F Date.now() is non-deterministic!
   Use game.time instead for deterministic timing.
   Example: const respawnAt = game.time + 3000;`),q.dateNow()},typeof performance<"u"&&(q.performanceNow=performance.now.bind(performance),performance.now=function(){return zt()&&Ot("performance.now",`\u26A0\uFE0F performance.now() is non-deterministic!
   Use game.time instead for deterministic timing.`),q.performanceNow()}),console.log("\u{1F6E1}\uFE0F Determinism guard enabled")}function pi(){q.mathRandom&&(Math.random=q.mathRandom),q.mathSqrt&&(Math.sqrt=q.mathSqrt),q.dateNow&&(Date.now=q.dateNow),q.performanceNow&&typeof performance<"u"&&(performance.now=q.performanceNow),Yt=null,Ut.clear(),Object.keys(q).forEach(i=>{delete q[i]})}var ui="bd14907";var oe=null,wo=null,fi=null,hi=null;var Sn=0,mi=0,bn=0;function yi(i,e={}){if(oe)return oe;hi=i||null,i&&"world"in i&&qt(i);let t=e.position||"top-right";oe=document.createElement("div"),oe.id="modu-debug-ui",oe.style.cssText=`
        position: fixed;
        ${t.includes("top")?"top: 10px":"bottom: 10px"};
        ${t.includes("right")?"right: 10px":"left: 10px"};
        background: rgba(0, 0, 0, 0.8);
        color: #0f0;
        font: 12px monospace;
        padding: 8px 12px;
        border-radius: 4px;
        z-index: 10000;
        min-width: 180px;
        user-select: text;
        cursor: text;
        
    `,document.body.appendChild(oe);let n=r=>{if(!oe)return;Sn++,r-bn>=1e3&&(mi=Sn,Sn=0,bn=r);let s=hi;if(!s){oe.innerHTML='<div style="color:#f00">No engine instance</div>';return}let a=s.getClientId(),l=s.getFrame(),c=s.getNodeUrl(),d=s.getLastSnapshot(),u=s.getServerFps(),f=s.getRoomId(),h=s.getUploadRate(),m=s.getDownloadRate(),g=s.getClients(),x=s.isAuthority?.()||!1,F="--------";try{if(fi){let A=fi();F=typeof A=="number"?A.toString(16).padStart(8,"0"):String(A).slice(0,8)}else F=s.getStateHash()}catch{F="error"}let C=A=>A>=1024?(A/1024).toFixed(1)+" kB/s":Math.round(A)+" B/s",w=C(h),U=C(m),B=s.getDriftStats?.()||{determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0},R=(Math.floor(B.determinismPercent*10)/10).toFixed(1),Y=B.determinismPercent===100?"#0f0":B.determinismPercent>=99?"#ff0":"#f00",L;x?L=`<span style="color:#888">I'm authority</span>`:B.totalChecks===0?L='<span style="color:#888">waiting...</span>':L=`<span style="color:${Y}">${R}%</span> <span style="color:#888">(${B.matchingFieldCount}/${B.totalFieldCount})</span>`;let X=d.frame?l-d.frame:0,H=d.hash?`${d.hash.slice(0,8)} <span style="color:#888">(${X} ago)</span>`:"none",le=A=>A>=1024*1024?(A/(1024*1024)).toFixed(2)+" MB":A>=1024?(A/1024).toFixed(1)+" KB":A+" B",I=d.size>0?le(d.size):"-",P=d.entityCount>0?String(d.entityCount):"-",z="color:#666;font-size:10px;margin-top:6px;margin-bottom:2px;border-bottom:1px solid #333;";oe.innerHTML=`
            <div style="${z}">ROOM</div>
            <div>ID: <span style="color:#fff">${f||"-"}</span></div>
            <div>Players: <span style="color:#ff0">${g.length}</span></div>
            <div>Frame: <span style="color:#fff">${l}</span></div>
            <div>URL: <span style="color:#0ff">${c||"-"}</span></div>

            <div style="${z}">ME</div>
            <div>Authority: <span style="color:${x?"#0ff":"#888"}">${x?"Yes":"No"}</span></div>
            <div>Client: <span style="color:#ff0">${a?a.slice(0,8):"-"}</span></div>

            <div style="${z}">ENGINE</div>
            <div>Commit: <span style="color:#888">${ui}</span></div>
            <div>FPS: <span style="color:#0f0">${mi}</span> render, <span style="color:#0f0">${u}</span> tick</div>
            <div>Net: <span style="color:#0f0">${w}</span> up, <span style="color:#f80">${U}</span> down</div>

            <div style="${z}">SNAPSHOT</div>
            <div>Current: <span style="color:#f0f">${F}</span></div>
            <div>Received: <span style="color:#f80">${H}</span></div>
            <div>Size: <span style="color:#fff">${I}</span>, Entities: <span style="color:#fff">${P}</span></div>
            <div>Last Sync: ${L}</div>
        `},o=r=>{n(r),wo=requestAnimationFrame(o)};return bn=performance.now(),requestAnimationFrame(o),oe}var Tn={};vt(Tn,{BodyType2D:()=>ze,DEFAULT_FILTER:()=>Wt,Layers:()=>Le,QuadTree2D:()=>rn,Shape2DType:()=>Ie,SpatialHash2D:()=>Ue,TriggerState:()=>sn,aabb2DArea:()=>xi,aabb2DOverlap:()=>Xt,aabb2DUnion:()=>gi,addBody2D:()=>nn,applyForce2D:()=>Di,applyImpulse2D:()=>In,computeAABB2D:()=>Ee,createBody2D:()=>Ye,createBox2D:()=>vi,createBox2DFromSize:()=>Ht,createCircle:()=>$t,createFilter:()=>Si,createWorld2D:()=>tn,detectCollision2D:()=>Jt,filterCollidingWith:()=>bi,filterExcluding:()=>Fi,getBody2DIdCounter:()=>dt,loadWorldState2D:()=>ki,makeTrigger:()=>Mi,removeBody2D:()=>qe,resetBody2DIdCounter:()=>Qt,resolveCollision2D:()=>en,saveWorldState2D:()=>Ai,setBody2DIdCounter:()=>pt,setBody2DMass:()=>Ei,setBody2DVelocity:()=>Ti,shouldCollide:()=>Gt,stepWorld2D:()=>ut,vec2:()=>jt,vec2Add:()=>Oe,vec2Clone:()=>Ci,vec2Cross:()=>Cn,vec2Dot:()=>Ii,vec2LengthSq:()=>Kt,vec2Scale:()=>fe,vec2Sub:()=>Fn,vec2Zero:()=>ct});var Ie=(t=>(t[t.Circle=0]="Circle",t[t.Box=1]="Box",t))(Ie||{});function Xt(i,e){return i.minX<=e.maxX&&i.maxX>=e.minX&&i.minY<=e.maxY&&i.maxY>=e.minY}function gi(i,e){return{minX:ee(i.minX,e.minX),minY:ee(i.minY,e.minY),maxX:re(i.maxX,e.maxX),maxY:re(i.maxY,e.maxY)}}function xi(i){let e=i.maxX-i.minX,t=i.maxY-i.minY;return p(e,t)}function $t(i){return{type:0,radius:y(i)}}function vi(i,e){return{type:1,halfWidth:y(i),halfHeight:y(e)}}function Ht(i,e){let t=y(i)>>1,n=y(e)>>1;return{type:1,halfWidth:t,halfHeight:n}}var Le={NONE:0,DEFAULT:1,PLAYER:2,ENEMY:4,PROJECTILE:8,ITEM:16,TRIGGER:32,WORLD:64,PROP:128,CUSTOM_1:256,CUSTOM_2:512,CUSTOM_3:1024,CUSTOM_4:2048,CUSTOM_5:4096,CUSTOM_6:8192,CUSTOM_7:16384,CUSTOM_8:32768,ALL:65535},Wt={layer:Le.DEFAULT,mask:Le.ALL};function Si(i,e=Le.ALL){return{layer:i,mask:e}}function Gt(i,e){return(i.mask&e.layer)!==0&&(e.mask&i.layer)!==0}function bi(i,...e){let t=0;for(let n of e)t|=n;return{layer:i,mask:t}}function Fi(i,...e){let t=Le.ALL;for(let n of e)t&=~n;return{layer:i,mask:t}}var Bo=y(0),Ro=y(.5),Ao=5461,ze=(n=>(n[n.Static=0]="Static",n[n.Kinematic=1]="Kinematic",n[n.Dynamic=2]="Dynamic",n))(ze||{});function ct(){return{x:0,y:0}}function jt(i,e){return{x:y(i),y:y(e)}}function Ci(i){return{x:i.x,y:i.y}}function Oe(i,e){return{x:i.x+e.x,y:i.y+e.y}}function Fn(i,e){return{x:i.x-e.x,y:i.y-e.y}}function fe(i,e){return{x:p(i.x,e),y:p(i.y,e)}}function Ii(i,e){return p(i.x,e.x)+p(i.y,e.y)}function Kt(i){return p(i.x,i.x)+p(i.y,i.y)}function Cn(i,e){return p(i.x,e.y)-p(i.y,e.x)}var Zt=1;function Qt(){Zt=1}function dt(){return Zt}function pt(i){Zt=i}function Ye(i,e,t,n,o){let r=i===2?y(1):0,s=i===2?65536:0,a=0;if(i===2)if(e.type===0){let d=e.radius;a=p(p(r,32768),p(d,d))}else{let d=e.halfWidth<<1,u=e.halfHeight<<1;a=p(p(r,Ao),p(d,d)+p(u,u))}let l=Zt++,c=o||"body2d_"+l;return{id:l,type:i,shape:e,label:c,position:jt(t,n),angle:0,linearVelocity:ct(),angularVelocity:0,mass:r,invMass:s,inertia:a||65536,invInertia:a?S(65536,a):0,restitution:Bo,friction:Ro,isSleeping:!1,sleepFrames:0,lockRotation:!1,isSensor:!1,isBullet:!1,filter:{...Wt},userData:null}}function Ei(i,e){i.type===2&&(i.mass=y(e),i.invMass=e>0?S(65536,i.mass):0)}function Ti(i,e,t){i.linearVelocity=jt(e,t),i.isSleeping=!1}function In(i,e,t){if(!(i.type!==2||i.invMass===0)){if(i.linearVelocity=Oe(i.linearVelocity,fe(e,i.invMass)),t&&!i.lockRotation){let n=Fn(t,i.position),o=Cn(n,e);i.angularVelocity=i.angularVelocity+p(o,i.invInertia)}i.isSleeping=!1}}function Di(i,e,t){if(i.type!==2||i.invMass===0)return;let n=fe(e,t);In(i,n)}function Ee(i){let{position:e,shape:t,angle:n}=i;if(t.type===0){let o=t.radius;return{minX:e.x-o,minY:e.y-o,maxX:e.x+o,maxY:e.y+o}}else{let o=t,r=o.halfWidth,s=o.halfHeight;if(n===0)return{minX:e.x-r,minY:e.y-s,maxX:e.x+r,maxY:e.y+s};let a=ge(n),l=ce(n),c=b(a),d=b(l),u=p(r,c)+p(s,d),f=p(r,d)+p(s,c);return{minX:e.x-u,minY:e.y-f,maxX:e.x+u,maxY:e.y+f}}}function Jt(i,e){let t=i.shape,n=e.shape;if(t.type===0&&n.type===0)return ko(i,e);if(t.type===1&&n.type===1)return Mo(i,e);if(t.type===0&&n.type===1)return wi(i,e);if(t.type===1&&n.type===0){let o=wi(e,i);return o?{bodyA:i,bodyB:e,point:o.point,normal:{x:-o.normal.x,y:-o.normal.y},depth:o.depth}:null}return null}function ko(i,e){let t=i.shape.radius,n=e.shape.radius,o=t+n,r=e.position.x-i.position.x,s=e.position.y-i.position.y,a=p(r,r)+p(s,s),l=p(o,o);if(a>=l)return null;let c=M(a),d=o-c,u,f;if(c>0){let g=S(65536,c);u=p(r,g),f=p(s,g)}else u=65536,f=0;let h=i.position.x+p(u,t),m=i.position.y+p(f,t);return{bodyA:i,bodyB:e,point:{x:h,y:m},normal:{x:u,y:f},depth:d}}function Mo(i,e){let t=i.shape,n=e.shape,o=e.position.x-i.position.x,r=e.position.y-i.position.y,s=t.halfWidth+n.halfWidth-b(o),a=t.halfHeight+n.halfHeight-b(r);if(s<=0||a<=0)return null;let l,c,d;s<a?(d=s,l=o>0?65536:-65536,c=0):(d=a,l=0,c=r>0?65536:-65536);let u=i.position.x+e.position.x>>1,f=i.position.y+e.position.y>>1;return{bodyA:i,bodyB:e,point:{x:u,y:f},normal:{x:l,y:c},depth:d}}function wi(i,e){let t=i.shape.radius,n=e.shape,o=i.position.x-e.position.x,r=i.position.y-e.position.y,s=re(-n.halfWidth,ee(n.halfWidth,o)),a=re(-n.halfHeight,ee(n.halfHeight,r)),l=b(o)<n.halfWidth&&b(r)<n.halfHeight,c,d,u;if(l){let m=n.halfWidth-o,g=n.halfWidth+o,x=n.halfHeight-r,F=n.halfHeight+r,C=m;c=65536,d=0,g<C&&(C=g,c=-65536,d=0),x<C&&(C=x,c=0,d=65536),F<C&&(C=F,c=0,d=-65536),u=C+t}else{let m=o-s,g=r-a,x=p(m,m)+p(g,g);if(x>=p(t,t))return null;let F=M(x);if(u=t-F,F>0){let C=S(65536,F);c=p(-m,C),d=p(-g,C)}else c=65536,d=0}let f=i.position.x+p(c,t),h=i.position.y+p(d,t);return{bodyA:i,bodyB:e,point:{x:f,y:h},normal:{x:c,y:d},depth:u}}function en(i){let{bodyA:e,bodyB:t,normal:n,depth:o}=i;if(e.isSensor||t.isSensor)return;let r=e.type,s=t.type;r===0&&s===0||(Po(e,t,n,o),(r===2||s===2)&&Vo(e,t,n))}function Po(i,e,t,n){let o=i.type,r=e.type,s=o!==0,a=r!==0;if(!s&&!a)return;let l=y(.01),c=re(0,n-l);if(!(c<=0))if(s&&a){let d=c>>1;i.position.x=i.position.x-p(t.x,d),i.position.y=i.position.y-p(t.y,d),e.position.x=e.position.x+p(t.x,d),e.position.y=e.position.y+p(t.y,d)}else s?(i.position.x=i.position.x-p(t.x,c),i.position.y=i.position.y-p(t.y,c)):(e.position.x=e.position.x+p(t.x,c),e.position.y=e.position.y+p(t.y,c))}function Vo(i,e,t){let n=i.type===2?i.invMass:0,o=e.type===2?e.invMass:0,r=n+o;if(r===0)return;let s=e.linearVelocity.x-i.linearVelocity.x,a=e.linearVelocity.y-i.linearVelocity.y,l=p(s,t.x)+p(a,t.y);if(l>0)return;let c=ee(i.restitution,e.restitution),d=S(p(-(65536+c),l),r),u=p(t.x,d),f=p(t.y,d);i.type===2&&(i.linearVelocity.x=i.linearVelocity.x-p(u,n),i.linearVelocity.y=i.linearVelocity.y-p(f,n)),e.type===2&&(e.linearVelocity.x=e.linearVelocity.x+p(u,o),e.linearVelocity.y=e.linearVelocity.y+p(f,o)),_o(i,e,t,d,n,o,r)}function _o(i,e,t,n,o,r,s){let a=e.linearVelocity.x-i.linearVelocity.x,l=e.linearVelocity.y-i.linearVelocity.y,c=p(a,t.x)+p(l,t.y),d=a-p(t.x,c),u=l-p(t.y,c),f=p(d,d)+p(u,u);if(f===0)return;let h=M(f),m=S(65536,h),g=p(d,m),x=p(u,m),F=p(i.friction,e.friction),C=p(a,g)+p(l,x),w=S(-C,s),U=p(F,b(n));b(w)>U&&(w=w>0?U:-U);let B=p(g,w),R=p(x,w);i.type===2&&(i.linearVelocity.x=i.linearVelocity.x-p(B,o),i.linearVelocity.y=i.linearVelocity.y-p(R,o)),e.type===2&&(e.linearVelocity.x=e.linearVelocity.x+p(B,r),e.linearVelocity.y=e.linearVelocity.y+p(R,r))}function No(i){if(i.shape.type===0)return T(i.shape.radius);{let e=i.shape,t=T(e.halfWidth),n=T(e.halfHeight);return Math.sqrt(t*t+n*n)}}var Ue=class{constructor(e=64){this.cells=new Map;this.bodyToCell=new Map;this.oversized=[];this.allRegular=[];this.cellSize=e,this.invCellSize=1/e}hashPosition(e,t){let n=Math.floor(e*this.invCellSize)&65535,o=Math.floor(t*this.invCellSize)&65535;return n<<16|o}clear(){this.cells.clear(),this.bodyToCell.clear(),this.oversized.length=0,this.allRegular.length=0}insert(e){if(No(e)*2>this.cellSize){this.oversized.push(e);return}this.allRegular.push(e);let o=T(e.position.x),r=T(e.position.y),s=this.hashPosition(o,r),a=this.cells.get(s);a||(a=[],this.cells.set(s,a)),a.push(e),this.bodyToCell.set(e,s)}insertAll(e){for(let t of e)this.insert(t)}queryPoint(e,t){let n=this.hashPosition(e,t);return this.cells.get(n)||[]}queryNearby(e){let t=T(e.position.x),n=T(e.position.y),o=Math.floor(t*this.invCellSize),r=Math.floor(n*this.invCellSize),s=[];for(let a=-1;a<=1;a++)for(let l=-1;l<=1;l++){let c=o+a&65535,d=r+l&65535,u=c<<16|d,f=this.cells.get(u);if(f)for(let h of f)h!==e&&s.push(h)}return s}queryRadius(e,t,n){let o=Math.ceil(n*this.invCellSize),r=Math.floor(e*this.invCellSize),s=Math.floor(t*this.invCellSize),a=[],l=new Set;for(let c=-o;c<=o;c++)for(let d=-o;d<=o;d++){let u=r+c&65535,f=s+d&65535,h=u<<16|f,m=this.cells.get(h);if(m)for(let g of m)l.has(g)||(l.add(g),a.push(g))}return a}forEachPair(e){for(let[o,r]of this.cells){for(let u=0;u<r.length;u++)for(let f=u+1;f<r.length;f++)e(r[u],r[f]);let s=o>>16&65535,a=o&65535,l=[(s+1&65535)<<16|a,s<<16|a+1&65535,(s+1&65535)<<16|a+1&65535];for(let u of l){if(u<=o)continue;let f=this.cells.get(u);if(f)for(let h of r)for(let m of f)e(h,m)}let c=(s-1&65535)<<16|a+1&65535,d=this.cells.get(c);if(d)for(let u of r)for(let f of d)e(u,f)}let t=this.oversized,n=this.allRegular;for(let o=0;o<t.length;o++)for(let r=o+1;r<t.length;r++)e(t[o],t[r]);for(let o of t)for(let r of n)e(o,r)}getPotentialPairs(){let e=[];return this.forEachPair((t,n)=>e.push([t,n])),e}getStats(){let e=0,t=0;for(let n of this.cells.values())e=Math.max(e,n.length),t+=n.length;return{cellCount:this.cells.size,maxPerCell:e,avgPerCell:this.cells.size>0?t/this.cells.size:0,oversizedCount:this.oversized.length}}};var Bi={x:0,y:y(-30)},Lo=y(.1),zo=y(.1),Ri=y(.12),Oo=20,Yo=64;function tn(i=1/60){let e={bodies:[],gravity:{x:Bi.x,y:Bi.y},dt:y(i),step(){ut(e)}};return e}function nn(i,e){i.bodies.push(e)}function qe(i,e){let t=i.bodies.indexOf(e);t>=0&&i.bodies.splice(t,1)}function ut(i){let{gravity:e,dt:t}=i,n=[],o=[],r=[],s=[...i.bodies].sort((l,c)=>l.label.localeCompare(c.label));for(let l of s){if(l.type!==2||l.isSleeping)continue;l.linearVelocity=Oe(l.linearVelocity,fe(e,t));let c=65536-Lo,d=65536-zo;l.linearVelocity=fe(l.linearVelocity,c),l.angularVelocity=p(l.angularVelocity,d)}let a=new Ue(Yo);a.insertAll(s),a.forEachPair((l,c)=>{if(l.type===0&&c.type===0||!Gt(l.filter,c.filter))return;let d=Ee(l),u=Ee(c);if(!Xt(d,u))return;let f=Jt(l,c);if(!f)return;let h=l.userData,m=c.userData;if((h||m)&&r.push({entityA:h,entityB:m,labelA:l.label,labelB:c.label}),l.isSensor||c.isSensor){l.isSensor&&o.push({trigger:l,other:c}),c.isSensor&&o.push({trigger:c,other:l});return}n.push(f),i.contactListener&&i.contactListener.onContact(l,c),en(f)}),r.sort((l,c)=>{let d=l.labelA.localeCompare(c.labelA);return d!==0?d:l.labelB.localeCompare(c.labelB)});for(let l of r)l.entityA?.active===!1||l.entityB?.active===!1||i.physics2d?.handleCollision?.(l.entityA,l.entityB)||(l.entityA?.onCollision&&l.entityA.onCollision(l.entityB),l.entityB?.onCollision&&l.entityB.onCollision(l.entityA));for(let l of s){if(l.type===0||l.isSleeping)continue;let c=y(.05),d=y(.01);b(l.linearVelocity.x)<c&&(l.linearVelocity.x=0),b(l.linearVelocity.y)<c&&(l.linearVelocity.y=0),b(l.angularVelocity)<d&&(l.angularVelocity=0),l.position=Oe(l.position,fe(l.linearVelocity,t)),!l.lockRotation&&l.angularVelocity!==0&&(l.angle=l.angle+p(l.angularVelocity,t));let u=Kt(l.linearVelocity),f=p(l.angularVelocity,l.angularVelocity),h=p(Ri,Ri);u<h&&f<h?(l.sleepFrames++,l.sleepFrames>=Oo&&(l.isSleeping=!0,l.linearVelocity=ct(),l.angularVelocity=0)):(l.sleepFrames=0,l.isSleeping=!1)}return{contacts:n,triggers:o}}function Uo(i){if(i.type===0)return{type:0,radius:i.radius};{let e=i;return{type:1,halfWidth:e.halfWidth,halfHeight:e.halfHeight}}}function qo(i){return i.type===0?{type:0,radius:i.radius}:{type:1,halfWidth:i.halfWidth,halfHeight:i.halfHeight}}function Xo(i){return{id:i.id,label:i.label,bodyType:i.type,shape:Uo(i.shape),px:i.position.x,py:i.position.y,angle:i.angle,vx:i.linearVelocity.x,vy:i.linearVelocity.y,av:i.angularVelocity,mass:i.mass,restitution:i.restitution,friction:i.friction,isSleeping:i.isSleeping,sleepFrames:i.sleepFrames,lockRotation:i.lockRotation,isSensor:i.isSensor,isBullet:i.isBullet,filter:{...i.filter},userData:i.userData}}function Ai(i){return{bodies:i.bodies.map(Xo)}}function $o(i){let e=qo(i.shape),t=dt(),n=Ye(i.bodyType,e,0,0,i.label);if(n.id=i.id,pt(t),n.position={x:i.px,y:i.py},n.angle=i.angle,n.linearVelocity={x:i.vx,y:i.vy},n.angularVelocity=i.av,n.mass=i.mass,n.invMass=i.mass>0?S(65536,i.mass):0,i.bodyType===2&&i.mass>0){if(e.type===0){let o=e.radius;n.inertia=p(p(i.mass,32768),p(o,o))}else{let o=e,r=o.halfWidth<<1,s=o.halfHeight<<1,a=5461;n.inertia=p(p(i.mass,a),p(r,r)+p(s,s))}n.invInertia=n.inertia>0?S(65536,n.inertia):0}return n.restitution=i.restitution,n.friction=i.friction,n.isSleeping=i.isSleeping,n.sleepFrames=i.sleepFrames,n.lockRotation=i.lockRotation,n.isSensor=i.isSensor,n.isBullet=i.isBullet??!1,n.filter={...i.filter},n.userData=i.userData,n}function ki(i,e){let t=[...e.bodies].sort((a,l)=>a.label.localeCompare(l.label)),n=new Set(t.map(a=>a.label));for(let a=i.bodies.length-1;a>=0;a--)n.has(i.bodies[a].label)||i.bodies.splice(a,1);let o=new Map(i.bodies.map(a=>[a.label,a])),r=0;for(let a of t){a.id>r&&(r=a.id);let l=o.get(a.label);if(l)l.position={x:a.px,y:a.py},l.angle=a.angle,l.linearVelocity={x:a.vx,y:a.vy},l.angularVelocity=a.av,l.isSleeping=a.isSleeping,l.sleepFrames=a.sleepFrames,l.lockRotation=a.lockRotation,l.isSensor=a.isSensor,l.restitution=a.restitution,l.friction=a.friction,l.filter={...a.filter},a.userData!==void 0&&(l.userData=a.userData);else{let c=$o(a);i.bodies.push(c)}}let s=dt();r>=s&&pt(r+1),i.bodies.sort((a,l)=>a.label.localeCompare(l.label))}var Ho=8,Wo=8;function Go(i,e){return i.minX<=e.maxX&&i.maxX>=e.minX&&i.minY<=e.maxY&&i.maxY>=e.minY}function on(i){let e=Ee(i);return{minX:T(e.minX),minY:T(e.minY),maxX:T(e.maxX),maxY:T(e.maxY)}}var En=class i{constructor(e,t,n,o){this.entities=[];this.children=null;this.bounds=e,this.depth=t,this.maxEntities=n,this.maxDepth=o}insert(e,t){if(this.children){let n=this.getChildIndex(t);if(n!==-1){this.children[n].insert(e,t);return}this.entities.push(e);return}this.entities.push(e),this.entities.length>this.maxEntities&&this.depth<this.maxDepth&&this.subdivide()}subdivide(){let{minX:e,minY:t,maxX:n,maxY:o}=this.bounds,r=(e+n)/2,s=(t+o)/2;this.children=[new i({minX:e,minY:t,maxX:r,maxY:s},this.depth+1,this.maxEntities,this.maxDepth),new i({minX:r,minY:t,maxX:n,maxY:s},this.depth+1,this.maxEntities,this.maxDepth),new i({minX:e,minY:s,maxX:r,maxY:o},this.depth+1,this.maxEntities,this.maxDepth),new i({minX:r,minY:s,maxX:n,maxY:o},this.depth+1,this.maxEntities,this.maxDepth)];let a=this.entities;this.entities=[];for(let l of a){let c=on(l),d=this.getChildIndex(c);d!==-1?this.children[d].insert(l,c):this.entities.push(l)}}getChildIndex(e){let{minX:t,minY:n,maxX:o,maxY:r}=this.bounds,s=(t+o)/2,a=(n+r)/2,l=e.maxY<=a,c=e.minY>=a,d=e.maxX<=s,u=e.minX>=s;return l&&d?0:l&&u?1:c&&d?2:c&&u?3:-1}query(e,t){for(let n of this.entities)t.push(n);if(this.children)for(let n of this.children)Go(n.bounds,e)&&n.query(e,t)}forEachPairIterative(e){let t=[],n=[];for(t.push({node:this,ancestorStart:0});t.length>0;){let{node:o,ancestorStart:r}=t.pop();n.length=r;let s=o.entities;for(let l=0;l<s.length;l++)for(let c=l+1;c<s.length;c++)e(s[l],s[c]);for(let l=0;l<r;l++)for(let c of s)e(n[l],c);let a=n.length;for(let l of s)n.push(l);if(o.children)for(let l=3;l>=0;l--)t.push({node:o.children[l],ancestorStart:n.length})}}forEachPair(e,t=[]){this.forEachPairIterative(e)}getStats(){let e=1,t=this.depth,n=this.entities.length;if(this.children)for(let o of this.children){let r=o.getStats();e+=r.nodeCount,t=Math.max(t,r.maxDepth),n+=r.entityCount}return{nodeCount:e,maxDepth:t,entityCount:n}}},rn=class{constructor(e=Ho,t=Wo){this.root=null;this.maxEntities=e,this.maxDepth=t}clear(){this.root=null}insertAll(e){if(e.length===0)return;let t=1/0,n=1/0,o=-1/0,r=-1/0;for(let a of e){let l=on(a);t=Math.min(t,l.minX),n=Math.min(n,l.minY),o=Math.max(o,l.maxX),r=Math.max(r,l.maxY)}let s=1;this.root=new En({minX:t-s,minY:n-s,maxX:o+s,maxY:r+s},0,this.maxEntities,this.maxDepth);for(let a of e){let l=on(a);this.root.insert(a,l)}}queryNearby(e){if(!this.root)return[];let t=[],n=on(e);return this.root.query(n,t),t.filter(o=>o!==e)}forEachPair(e){this.root&&this.root.forEachPair(e)}getStats(){return this.root?this.root.getStats():{nodeCount:0,maxDepth:0,entityCount:0}}};var sn=class{constructor(){this.overlaps=new Map;this.enterCallbacks=[];this.stayCallbacks=[];this.exitCallbacks=[];this.pendingPairs=[]}onEnter(e){this.enterCallbacks.push(e)}onStay(e){this.stayCallbacks.push(e)}onExit(e){this.exitCallbacks.push(e)}processOverlaps(e){let t=new Set,n=[...e].sort((r,s)=>this.makeKey(r.trigger,r.other).localeCompare(this.makeKey(s.trigger,s.other)));for(let r of n){let s=this.makeKey(r.trigger,r.other);if(t.add(s),this.overlaps.has(s))for(let a of this.stayCallbacks)a(r);else{this.overlaps.set(s,r);for(let a of this.enterCallbacks)a(r)}}let o=[...this.overlaps.keys()].sort();for(let r of o)if(!t.has(r)){let s=this.overlaps.get(r);this.overlaps.delete(r);for(let a of this.exitCallbacks)a(s)}}clear(){this.overlaps.clear()}removeBody(e){let t=[];for(let[n,o]of this.overlaps)(o.trigger===e||o.other===e)&&t.push(n);t.sort();for(let n of t){let o=this.overlaps.get(n);this.overlaps.delete(n);for(let r of this.exitCallbacks)r(o)}}getOverlappingBodies(e){let t=[];for(let n of this.overlaps.values())n.trigger===e&&t.push(n.other);return t.sort((n,o)=>n.label.localeCompare(o.label))}isBodyInTrigger(e,t){return this.overlaps.has(this.makeKey(e,t))}overlapCount(){return this.overlaps.size}saveState(){let e=[];for(let t of this.overlaps.values())e.push([t.trigger.label,t.other.label]);return e.sort((t,n)=>t[0].localeCompare(n[0])||t[1].localeCompare(n[1]))}loadState(e){this.overlaps.clear(),this.pendingPairs=e}syncWithWorld(e){let t=new Map;for(let n of e)t.set(n.label,n);for(let[n,o]of this.pendingPairs){let r=t.get(n),s=t.get(o);r&&s&&this.overlaps.set(this.makeKey(r,s),{trigger:r,other:s})}this.pendingPairs=[]}makeKey(e,t){return`${e.label}:${t.label}`}};function Mi(i){return i.isSensor=!0,i}var ft=class{constructor(e,t){this.world=null;this.entityToBody=new Map;this.bodyToEntity=new Map;this.collisionHandlers=new Map;this.pendingEntities=new Set;let n,o=null;e&&"world"in e?(o=e,n=t??{}):n=e??{},this.physicsWorld=tn(n.dt??1/60),n.gravity&&(this.physicsWorld.gravity={x:y(n.gravity.x),y:y(n.gravity.y)});let r=this;this.physicsWorld.contactListener={onContact(s,a){r.handleCollision(s,a)}},this.physicsWorld.physics2d={handleCollision:(s,a)=>this.handleCollisionByType(s,a)},o&&(this.attach(o.world),o.physics=this)}attach(e){return this.world=e,e.addSystem(()=>this.syncBodiesToPhysics(),{phase:"prePhysics",order:0}),e.addSystem(()=>this.step(),{phase:"physics",order:0}),e.addSystem(()=>this.syncPhysicsToComponents(),{phase:"postPhysics",order:0}),this}onCollision(e,t,n){let o=`${e}:${t}`,r=`${t}:${e}`;return this.collisionHandlers.set(o,n),e!==t&&this.collisionHandlers.set(r,(s,a)=>n(a,s)),this}setGravity(e,t){return this.physicsWorld.gravity={x:y(e),y:y(t)},this}ensureBody(e){let t=e.eid,n=this.entityToBody.get(t);if(n)return n;if(!e.has($)||!e.has(K))return null;let o=e.get($),r=e.get(K),s;switch(r.bodyType){case tt:s=0;break;case nt:s=1;break;default:s=2}let a;return r.shapeType===Me||r.radius>0?a=$t(r.radius||10):a=Ht(r.width||10,r.height||10),n=Ye(s,a,o.x,o.y),n.angle=y(o.angle),n.linearVelocity={x:y(r.vx),y:y(r.vy)},n.isSensor=r.isSensor,n.isSleeping=!1,n.sleepFrames=0,n.userData=e,n.label=t.toString(),nn(this.physicsWorld,n),this.entityToBody.set(t,n),this.bodyToEntity.set(n.id,t),n}removeBody(e){let t=e.eid,n=this.entityToBody.get(t);n&&(qe(this.physicsWorld,n),this.entityToBody.delete(t),this.bodyToEntity.delete(n.id))}syncBodiesToPhysics(){if(this.world){for(let e of this.world.query(K)){let t=this.ensureBody(e);if(!t)continue;let n=e.get(K);if(n.bodyType===nt||n.bodyType===tt){let s=e.get($);t.position.x=y(s.x),t.position.y=y(s.y),t.angle=y(s.angle)}if((n.impulseX!==0||n.impulseY!==0)&&(n.vx+=n.impulseX,n.vy+=n.impulseY,n.impulseX=0,n.impulseY=0),(n.forceX!==0||n.forceY!==0)&&(n.vx+=n.forceX,n.vy+=n.forceY,n.forceX=0,n.forceY=0),n.damping>0){let s=1-n.damping;n.vx*=s,n.vy*=s}let o=y(n.vx),r=y(n.vy);if(t.linearVelocity.x=o,t.linearVelocity.y=r,(o!==0||r!==0)&&(t.isSleeping=!1,t.sleepFrames=0),t.shape.type===0){let s=t.shape.radius,a=y(n.radius);s!==a&&(t.shape.radius=a)}}for(let[e,t]of this.entityToBody)this.world.isDestroyed(e)&&(qe(this.physicsWorld,t),this.entityToBody.delete(e),this.bodyToEntity.delete(t.id))}}step(){ut(this.physicsWorld)}syncPhysicsToComponents(){for(let[e,t]of this.entityToBody){let n=this.world?.getEntity(e);if(!n||n.destroyed)continue;let o=n.get($),r=n.get(K);o.x=T(t.position.x),o.y=T(t.position.y),o.angle=T(t.angle),r.vx=T(t.linearVelocity.x),r.vy=T(t.linearVelocity.y)}}handleCollision(e,t){let n=e.userData,o=t.userData;!n||!o||n.destroyed||o.destroyed||this.handleCollisionByType(n,o)}handleCollisionByType(e,t){if(!e||!t||e.destroyed||t.destroyed)return!1;let n=`${e.type}:${t.type}`,o=this.collisionHandlers.get(n);return o?(o(e,t),e.type===t.type&&!e.destroyed&&!t.destroyed&&o(t,e),!0):!1}getBody(e){return this.entityToBody.get(e.eid)}getEntityForBody(e){let t=this.bodyToEntity.get(e.id);return t===void 0?null:this.world?.getEntity(t)??null}clear(){for(let e of this.entityToBody.values())qe(this.physicsWorld,e);this.entityToBody.clear(),this.bodyToEntity.clear(),Qt()}wakeAllBodies(){for(let e of this.physicsWorld.bodies)e.isSleeping=!1,e.sleepFrames=0}};function Pi(i={}){return new ft(i)}var wn={};vt(wn,{BodyType:()=>ln,DEFAULT_FILTER:()=>an,Layers:()=>$e,ShapeType:()=>Xe,TriggerState:()=>He,aabbOverlap:()=>ht,addBody:()=>Zi,applyForce:()=>Hi,applyImpulse:()=>he,computeAABB:()=>Te,createBody:()=>qi,createBox:()=>Vi,createFilter:()=>Ni,createSphere:()=>_i,createWorld:()=>Ki,detectCollision:()=>De,filterCollidingWith:()=>Li,filterExcluding:()=>zi,getBodyIdCounter:()=>Yi,isGrounded:()=>Ji,loadWorldState:()=>no,makeTrigger:()=>ji,raycast:()=>eo,removeBody:()=>Qi,resetBodyIdCounter:()=>Oi,resolveCollision:()=>dn,saveWorldState:()=>to,setBodyIdCounter:()=>Ui,setBodyMass:()=>Xi,setBodyVelocity:()=>$i,shouldCollide:()=>mt,stepWorld:()=>Dn});var Xe=(t=>(t[t.Box=0]="Box",t[t.Sphere=1]="Sphere",t))(Xe||{});function Vi(i,e,t){return{type:0,halfExtents:xe(i,e,t)}}function _i(i){return{type:1,radius:y(i)}}function ht(i,e){return i.max.x>=e.min.x&&i.min.x<=e.max.x&&i.max.y>=e.min.y&&i.min.y<=e.max.y&&i.max.z>=e.min.z&&i.min.z<=e.max.z}var $e={NONE:0,DEFAULT:1,PLAYER:2,ENEMY:4,PROJECTILE:8,ITEM:16,TRIGGER:32,WORLD:64,PROP:128,CUSTOM_1:256,CUSTOM_2:512,CUSTOM_3:1024,CUSTOM_4:2048,CUSTOM_5:4096,CUSTOM_6:8192,CUSTOM_7:16384,CUSTOM_8:32768,ALL:65535},an={layer:$e.DEFAULT,mask:$e.ALL};function Ni(i,e=$e.ALL){return{layer:i,mask:e}}function mt(i,e){return(i.mask&e.layer)!==0&&(e.mask&i.layer)!==0}function Li(i,...e){let t=0;for(let n of e)t|=n;return{layer:i,mask:t}}function zi(i,...e){let t=$e.ALL;for(let n of e)t&=~n;return{layer:i,mask:t}}var jo=y(0),Ko=y(.5),ln=(n=>(n[n.Static=0]="Static",n[n.Kinematic=1]="Kinematic",n[n.Dynamic=2]="Dynamic",n))(ln||{}),yt=1;function Oi(){yt=1}function Yi(){return yt}function Ui(i){yt=i}function qi(i,e,t,n,o,r){let s=i===2?y(1):0,a=i===2?65536:0,l=0;if(i===2)if(e.type===0){let u=e.halfExtents;l=p(s,p(y(1/6),p(u.x,u.x)+p(u.y,u.y)+p(u.z,u.z)))}else{let u=e.radius;l=p(s,p(y(.4),p(u,u)))}let c=r||"body_"+yt;return{id:yt++,label:c,type:i,shape:e,position:xe(t,n,o),rotation:Ze(),linearVelocity:se(),angularVelocity:se(),mass:s,invMass:a,inertia:l||65536,invInertia:l?S(65536,l):0,restitution:jo,friction:Ko,isSleeping:!1,sleepFrames:0,lockRotationX:!1,lockRotationY:!1,lockRotationZ:!1,isTrigger:!1,filter:{...an},userData:null}}function Xi(i,e){i.type===2&&(i.mass=y(e),i.invMass=e>0?S(65536,i.mass):0)}function $i(i,e,t,n){i.linearVelocity=xe(e,t,n),i.isSleeping=!1}function he(i,e,t){if(!(i.type!==2||i.invMass===0)){if(i.linearVelocity=_(i.linearVelocity,D(e,i.invMass)),t){let n=V(t,i.position),o=j(n,e);i.angularVelocity=_(i.angularVelocity,D(o,i.invInertia))}i.isSleeping=!1}}function Hi(i,e,t){if(i.type!==2||i.invMass===0)return;let n=D(e,t);he(i,n)}var Wi=y(.6),cn=y(.05),Zo=y(1.5);function Te(i){let e=i.position,t=i.shape;if(t.type===1){let n=t.radius;return{min:{x:e.x-n,y:e.y-n,z:e.z-n},max:{x:e.x+n,y:e.y+n,z:e.z+n}}}else{let n=t.halfExtents,o=G(i.rotation,k(65536,0,0)),r=G(i.rotation,k(0,65536,0)),s=G(i.rotation,k(0,0,65536)),a=b(p(o.x,n.x))+b(p(r.x,n.y))+b(p(s.x,n.z)),l=b(p(o.y,n.x))+b(p(r.y,n.y))+b(p(s.y,n.z)),c=b(p(o.z,n.x))+b(p(r.z,n.y))+b(p(s.z,n.z));return{min:{x:e.x-a,y:e.y-l,z:e.z-c},max:{x:e.x+a,y:e.y+l,z:e.z+c}}}}function Qo(i,e){let t=i.shape,n=e.shape,o=V(i.position,e.position),r=W(o),s=t.radius+n.radius,a=p(s,s);if(r>=a)return null;let l=M(r),c=l>0?D(o,S(65536,l)):k(65536,0,0),d=s-l,u=V(i.position,D(c,t.radius));return{bodyA:i,bodyB:e,normal:c,points:[{point:u,penetration:d}]}}function Gi(i,e){let t=i.shape,n=e.shape,o=V(i.position,e.position),r=Bt(e.rotation),s=G(r,o),a=n.halfExtents,l={x:we(s.x,-a.x,a.x),y:we(s.y,-a.y,a.y),z:we(s.z,-a.z,a.z)},c=V(s,l),d=W(c),u=p(t.radius,t.radius);if(d>=u)return null;let f=M(d),h,m;if(f>0)h=D(c,S(65536,f)),m=t.radius-f;else{let F=a.x-b(s.x),C=a.y-b(s.y),w=a.z-b(s.z);F<=C&&F<=w?(h=s.x>=0?k(65536,0,0):k(-65536,0,0),m=F+t.radius):C<=w?(h=s.y>=0?k(0,65536,0):k(0,-65536,0),m=C+t.radius):(h=s.z>=0?k(0,0,65536):k(0,0,-65536),m=w+t.radius)}let g=_(e.position,G(e.rotation,l)),x=G(e.rotation,h);return{bodyA:i,bodyB:e,normal:x,points:[{point:g,penetration:m}]}}function Jo(i,e){let t=i.shape,n=e.shape,o=t.halfExtents,r=n.halfExtents,s=[G(i.rotation,k(65536,0,0)),G(i.rotation,k(0,65536,0)),G(i.rotation,k(0,0,65536))],a=[G(e.rotation,k(65536,0,0)),G(e.rotation,k(0,65536,0)),G(e.rotation,k(0,0,65536))],l=[o.x,o.y,o.z],c=[r.x,r.y,r.z],d=V(e.position,i.position),u=2147483647,f=k(0,65536,0);function h(I,P,z){return b(p(N(I[0],z),P[0]))+b(p(N(I[1],z),P[1]))+b(p(N(I[2],z),P[2]))}function m(I){let P=W(I);if(P<y(1e-4))return!0;let z=M(P),A=D(I,S(65536,z)),me=h(s,l,A),Ge=h(a,c,A),je=b(N(d,A)),ye=me+Ge-je;return ye<=0?!1:(ye<u&&(u=ye,f=N(d,A)<0?A:de(A)),!0)}for(let I=0;I<3;I++)if(!m(s[I])||!m(a[I]))return null;for(let I=0;I<3;I++)for(let P=0;P<3;P++)if(!m(j(s[I],a[P])))return null;let g=[],x=p(p(o.x,o.y),o.z),F=p(p(r.x,r.y),r.z),C=F<=x?e:i,w=F<=x?r:o,U=F<=x?i:e,B=[[-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1],[1,1,1]],R=F<=x?f:de(f),Y=[],L=F<=x?s:a,X=F<=x?o:r;for(let[I,P,z]of B){let A=k(p(w.x,y(I)),p(w.y,y(P)),p(w.z,y(z))),me=_(C.position,G(C.rotation,A)),Ge=V(me,U.position),je=N(Ge,R),ye=p(b(N(L[0],R)),X.x)+p(b(N(L[1],R)),X.y)+p(b(N(L[2],R)),X.z),xt=je+ye;xt>0&&Y.push({point:me,depth:xt})}Y.sort((I,P)=>{let z=P.depth-I.depth;return z!==0?z:I.point.x-P.point.x||I.point.y-P.point.y||I.point.z-P.point.z});let H=y(.05),le=Y.length>0?Y[0].depth:0;for(let I of Y)if(I.depth>le-H&&g.push({point:I.point,penetration:I.depth}),g.length>=4)break;if(g.length===0){let I=D(_(i.position,e.position),32768);g.push({point:I,penetration:u})}return{bodyA:i,bodyB:e,normal:f,points:g}}function De(i,e){let t=i.shape.type,n=e.shape.type;if(t===1&&n===1)return Qo(i,e);if(t===1&&n===0)return Gi(i,e);if(t===0&&n===1){let o=Gi(e,i);return o?{bodyA:i,bodyB:e,normal:de(o.normal),points:o.points}:null}else return Jo(i,e)}function dn(i){let{bodyA:e,bodyB:t,normal:n,points:o}=i;if(e.invMass===0&&t.invMass===0||o.length===0)return;let r=V(e.linearVelocity,t.linearVelocity);if(b(N(r,n))<Zo&&(e.isSleeping||t.isSleeping)){for(let f of o){let h=f.penetration;if(h>cn){let m=e.invMass+t.invMass;if(m>0){let g=p(S(h-cn,m),Wi),x=D(n,g);e.invMass>0&&!e.isSleeping&&(e.position=_(e.position,D(x,e.invMass))),t.invMass>0&&!t.isSleeping&&(t.position=V(t.position,D(x,t.invMass)))}}}return}let l=o.length,c=S(65536,y(l)),d=ee(e.restitution,t.restitution),u=S(e.friction+t.friction,y(2));for(let f of o){let h=f.point,m=f.penetration,g=V(h,e.position),x=V(h,t.position),F=_(e.linearVelocity,j(e.angularVelocity,g)),C=_(t.linearVelocity,j(t.angularVelocity,x)),w=V(F,C),U=N(w,n);if(U<0){let B=j(g,n),R=j(x,n),Y=e.lockRotationX&&e.lockRotationY&&e.lockRotationZ?0:p(N(B,B),e.invInertia),L=t.lockRotationX&&t.lockRotationY&&t.lockRotationZ?0:p(N(R,R),t.invInertia),X=e.invMass+t.invMass+Y+L,H=p(-(65536+d),U);H=S(H,X),H=p(H,c);let le=D(n,H);e.invMass>0&&he(e,le,h),t.invMass>0&&he(t,de(le),h);let I=V(w,D(n,U)),P=W(I);if(P>y(1e-4)){let z=ae(I),A=j(g,z),me=j(x,z),Ge=e.lockRotationX&&e.lockRotationY&&e.lockRotationZ?0:p(N(A,A),e.invInertia),je=t.lockRotationX&&t.lockRotationY&&t.lockRotationZ?0:p(N(me,me),t.invInertia),ye=e.invMass+t.invMass+Ge+je,xt=M(P),Ke=S(xt,ye);Ke=p(Ke,c);let kn=p(b(H),u);Ke>kn&&(Ke=kn);let Mn=D(z,-Ke);e.invMass>0&&he(e,Mn,h),t.invMass>0&&he(t,de(Mn),h)}}if(m>cn){let B=e.invMass+t.invMass,R=p(S(m-cn,B),Wi),Y=p(R,c),L=D(n,Y);e.invMass>0&&(e.position=_(e.position,D(L,e.invMass))),t.invMass>0&&(t.position=V(t.position,D(L,t.invMass)))}}}var He=class{constructor(){this.overlaps=new Map;this.enterCallbacks=[];this.stayCallbacks=[];this.exitCallbacks=[];this.pendingPairs=[]}onEnter(e){this.enterCallbacks.push(e)}onStay(e){this.stayCallbacks.push(e)}onExit(e){this.exitCallbacks.push(e)}processOverlaps(e){let t=new Set,n=[...e].sort((r,s)=>this.makeKey(r.trigger,r.other).localeCompare(this.makeKey(s.trigger,s.other)));for(let r of n){let s=this.makeKey(r.trigger,r.other);if(t.add(s),this.overlaps.has(s))for(let a of this.stayCallbacks)a(r);else{this.overlaps.set(s,r);for(let a of this.enterCallbacks)a(r)}}let o=[...this.overlaps.keys()].sort();for(let r of o)if(!t.has(r)){let s=this.overlaps.get(r);this.overlaps.delete(r);for(let a of this.exitCallbacks)a(s)}}clear(){this.overlaps.clear()}removeBody(e){let t=[];for(let[n,o]of this.overlaps)(o.trigger===e||o.other===e)&&t.push(n);t.sort();for(let n of t){let o=this.overlaps.get(n);this.overlaps.delete(n);for(let r of this.exitCallbacks)r(o)}}getOverlappingBodies(e){let t=[];for(let n of this.overlaps.values())n.trigger===e&&t.push(n.other);return t.sort((n,o)=>n.label.localeCompare(o.label))}isBodyInTrigger(e,t){return this.overlaps.has(this.makeKey(e,t))}overlapCount(){return this.overlaps.size}saveState(){let e=[];for(let t of this.overlaps.values())e.push([t.trigger.label,t.other.label]);return e.sort((t,n)=>t[0].localeCompare(n[0])||t[1].localeCompare(n[1]))}loadState(e){this.overlaps.clear(),this.pendingPairs=e}syncWithWorld(e){let t=new Map;for(let n of e)t.set(n.label,n);for(let[n,o]of this.pendingPairs){let r=t.get(n),s=t.get(o);r&&s&&this.overlaps.set(this.makeKey(r,s),{trigger:r,other:s})}this.pendingPairs=[]}makeKey(e,t){return`${e.label}:${t.label}`}};function ji(i){return i.isTrigger=!0,i}var er={x:0,y:y(-30),z:0},tr=y(.1),nr=y(.1),We=y(.12),ir=20,or=10,rr=8;function Ki(i=1/60){let e={bodies:[],gravity:It(er),dt:y(i),triggers:new He,step(){return Dn(e)}};return e}function Zi(i,e){i.bodies.push(e)}function Qi(i,e){let t=i.bodies.indexOf(e);t>=0&&(i.bodies.splice(t,1),i.triggers.removeBody(e))}function Ji(i,e,t=.15){let n=y(t);for(let o of i.bodies){if(o===e)continue;let r=De(e,o);if(r&&r.normal.y>32768)return!0;let s=e.position.y;e.position.y=e.position.y-n;let a=De(e,o);if(e.position.y=s,a&&a.normal.y>32768)return!0}return!1}function Dn(i){let{gravity:e,dt:t,triggers:n}=i,o=[],r=[],s=[...i.bodies].sort((c,d)=>c.label.localeCompare(d.label)),a=new Set,l=new Set;for(let c=0;c<s.length;c++)for(let d=c+1;d<s.length;d++){let u=s[c],f=s[d];if(u.invMass===0&&f.invMass===0||!mt(u.filter,f.filter))continue;let h=Te(u),m=Te(f);if(!ht(h,m))continue;let g=De(u,f);g&&b(g.normal.y)>32768&&(a.add(u),a.add(f),u.isSleeping&&f.type===2&&W(f.linearVelocity)+W(f.angularVelocity)<p(We,We)&&l.add(f),f.isSleeping&&u.type===2&&W(u.linearVelocity)+W(u.angularVelocity)<p(We,We)&&l.add(u))}for(let c of s){if(c.type!==2||c.isSleeping)continue;c.linearVelocity=_(c.linearVelocity,D(e,t));let d=65536-tr,u=65536-nr;a.has(c)&&(d=p(d,y(.95)),u=p(u,y(.9))),c.linearVelocity=D(c.linearVelocity,d),c.angularVelocity=D(c.angularVelocity,u)}for(let c=0;c<rr;c++)for(let d=0;d<s.length;d++)for(let u=d+1;u<s.length;u++){let f=s[d],h=s[u];if(f.invMass===0&&h.invMass===0||!mt(f.filter,h.filter))continue;let m=Te(f),g=Te(h);if(!ht(m,g))continue;let x=De(f,h);x&&(f.isTrigger||h.isTrigger?c===0&&(f.isTrigger&&r.push({trigger:f,other:h}),h.isTrigger&&r.push({trigger:h,other:f})):(c===0&&o.push(x),dn(x)))}n.processOverlaps(r);for(let c of s){if(c.type===0||c.isSleeping)continue;let d=y(.05);if(b(c.linearVelocity.x)<d&&(c.linearVelocity.x=0),b(c.linearVelocity.y)<d&&(c.linearVelocity.y=0),b(c.linearVelocity.z)<d&&(c.linearVelocity.z=0),c.position=_(c.position,D(c.linearVelocity,t)),c.lockRotationX&&c.lockRotationY&&c.lockRotationZ)continue;let u=c.lockRotationX?0:c.angularVelocity.x,f=c.lockRotationY?0:c.angularVelocity.y,h=c.lockRotationZ?0:c.angularVelocity.z,m=y(.01);b(u)<m&&(u=0),b(f)<m&&(f=0),b(h)<m&&(h=0),c.angularVelocity.x=u,c.angularVelocity.y=f,c.angularVelocity.z=h;let g=p(u,u)+p(f,f)+p(h,h);if(g>0){let w=M(g),U=p(w,t),B=S(65536,w),R={x:p(u,B),y:p(f,B),z:p(h,B)},Y=Tt(R,U);c.rotation=wt(Dt(Y,c.rotation))}let x=W(c.linearVelocity),F=W(c.angularVelocity),C=p(We,We);if(x<C&&F<C){let w=l.has(c)?1+or:1;c.sleepFrames+=w,c.sleepFrames>=ir&&(c.isSleeping=!0,c.linearVelocity=se(),c.angularVelocity=se())}else c.sleepFrames=0,c.isSleeping=!1}return o}function eo(i,e,t,n){let o=ae(t),r=null,s=n;for(let a of i.bodies){let l=sr(a,e,o,s);l&&l.distance<s&&(s=l.distance,r=l)}return r}function sr(i,e,t,n){return i.shape.type===1?ar(i,e,t,n):lr(i,e,t,n)}function ar(i,e,t,n){let o=i.shape,r=V(e,i.position),s=N(t,t),a=p(y(2),N(r,t)),l=N(r,r)-p(o.radius,o.radius),c=p(a,a)-p(p(y(4),s),l);if(c<0)return null;let d=M(c),u=S(-a-d,p(y(2),s));if(u<0&&(u=S(-a+d,p(y(2),s)),u<0)||u>n)return null;let f=_(e,D(t,u)),h=ae(V(f,i.position));return{body:i,point:f,normal:h,distance:u}}function lr(i,e,t,n){let r=i.shape.halfExtents,s=i.position,a=-2147483647,l=2147483647,c=0,d=1;{let h=t.x!==0?S(65536,t.x):2147483647,m=p(s.x-r.x-e.x,h),g=p(s.x+r.x-e.x,h);if(h<0&&([m,g]=[g,m]),m>a&&(a=m,c=0,d=h<0?1:-1),g<l&&(l=g),l<a)return null}{let h=t.y!==0?S(65536,t.y):2147483647,m=p(s.y-r.y-e.y,h),g=p(s.y+r.y-e.y,h);if(h<0&&([m,g]=[g,m]),m>a&&(a=m,c=1,d=h<0?1:-1),g<l&&(l=g),l<a)return null}{let h=t.z!==0?S(65536,t.z):2147483647,m=p(s.z-r.z-e.z,h),g=p(s.z+r.z-e.z,h);if(h<0&&([m,g]=[g,m]),m>a&&(a=m,c=2,d=h<0?1:-1),g<l&&(l=g),l<a)return null}if(a<0||a>n)return null;let u=_(e,D(t,a)),f=k(c===0?y(d):0,c===1?y(d):0,c===2?y(d):0);return{body:i,point:u,normal:f,distance:a}}function to(i){return{bodies:i.bodies.map(e=>({id:e.id,label:e.label,px:e.position.x,py:e.position.y,pz:e.position.z,qx:e.rotation.x,qy:e.rotation.y,qz:e.rotation.z,qw:e.rotation.w,vx:e.linearVelocity.x,vy:e.linearVelocity.y,vz:e.linearVelocity.z,avx:e.angularVelocity.x,avy:e.angularVelocity.y,avz:e.angularVelocity.z,isSleeping:e.isSleeping,sleepFrames:e.sleepFrames}))}}function no(i,e){let t=new Set(e.bodies.map(o=>o.label));for(let o=i.bodies.length-1;o>=0;o--)t.has(i.bodies[o].label)||i.bodies.splice(o,1);let n=new Map(i.bodies.map(o=>[o.label,o]));for(let o of e.bodies){let r=n.get(o.label);r&&(r.position={x:o.px,y:o.py,z:o.pz},r.rotation={x:o.qx,y:o.qy,z:o.qz,w:o.qw},r.linearVelocity={x:o.vx,y:o.vy,z:o.vz},r.angularVelocity={x:o.avx,y:o.avy,z:o.avz},r.isSleeping=o.isSleeping,r.sleepFrames=o.sleepFrames)}}function io(i,e={}){let t=e.inputDelay??2;return{currentFrame:0,localPlayerId:i,players:new Set([i]),config:{inputDelay:t,maxRollbackFrames:e.maxRollbackFrames??8,maxPredictionFrames:e.maxPredictionFrames??8,snapshotInterval:e.snapshotInterval??1},inputBuffer:{inputs:new Map,lastConfirmedFrame:-1,lastReceivedFrame:new Map([[i,0]])},localInputQueue:[],snapshots:new Map,saveState:()=>({}),loadState:()=>{},tick:()=>{},computeChecksum:()=>0,rollbackCount:0,maxRollbackDepth:0,predictionMisses:0}}function oo(i,e){i.players.add(e),i.inputBuffer.lastReceivedFrame.set(e,-1)}function ro(i,e,t){i.players.add(e),i.inputBuffer.lastReceivedFrame.set(e,t),t-1>i.inputBuffer.lastConfirmedFrame&&(i.inputBuffer.lastConfirmedFrame=t-1)}function so(i,e){for(let t of i.snapshots.keys())t<e&&i.snapshots.delete(t);for(let t of i.inputBuffer.inputs.keys())t<e&&i.inputBuffer.inputs.delete(t)}function ao(i,e){i.players.delete(e),i.inputBuffer.lastReceivedFrame.delete(e)}function lo(i,e){let{currentFrame:t,config:n,localPlayerId:o,inputBuffer:r}=i,s=t+n.inputDelay,a={frame:s,playerId:o,data:e,predicted:!1};i.localInputQueue.push(a),gt(i,a);let l=r.lastReceivedFrame.get(o)??-1;s>l&&r.lastReceivedFrame.set(o,s);for(let c=t;c<s;c++){let u=r.inputs.get(c)?.find(f=>f.playerId===o);u?(u.predicted||c===t)&&(u.data=e):gt(i,{frame:c,playerId:o,data:e,predicted:!0})}}function co(i,e,t,n){let{config:o,inputBuffer:r,currentFrame:s}=i;gt(i,{frame:e,playerId:t,data:n,predicted:!1});let l=Math.max(0,e-o.inputDelay),c=e;for(let u=l;u<c;u++){let f=u<=s,h=u>s&&u<s+o.inputDelay,m=u<s-o.maxRollbackFrames;if((f||h)&&!m){let x=r.inputs.get(u)?.find(C=>C.playerId===t&&!C.predicted);if(x){u===s&&(x.data=n);continue}gt(i,{frame:u,playerId:t,data:n,predicted:!1})}}let d=r.lastReceivedFrame.get(t)??-1;e>d&&r.lastReceivedFrame.set(t,e)}function gt(i,e){let{inputBuffer:t}=i;t.inputs.has(e.frame)||t.inputs.set(e.frame,[]);let n=t.inputs.get(e.frame),o=n.findIndex(r=>r.playerId===e.playerId);if(o>=0){let r=n[o];if(r.predicted&&!e.predicted&&cr(r.data,e.data)){i.predictionMisses++;let s=i.pendingRollbackFrame;(s===void 0||e.frame<s)&&(i.pendingRollbackFrame=e.frame)}n[o]=e}else n.push(e)}function cr(i,e){if(!i&&!e)return!1;if(!i||!e)return!0;let t=new Set(["yaw","yawFp","pitch","pitchFp","roll","rollFp","shootDirX","shootDirY","shootDirZ","lookX","lookY","rotX","rotY","rotZ","mouseX","mouseY","aimX","aimY","aimZ"]),n=new Set([...Object.keys(i||{}),...Object.keys(e||{})]);for(let o of n)if(!t.has(o)&&i[o]!==e[o])return!0;return!1}function pn(i,e){let{inputBuffer:t,players:n,localPlayerId:o}=i,r=[],s=Array.from(n).sort();for(let a of s){let l=t.inputs.get(e),c=l?.find(f=>f.playerId===a&&!f.predicted);if(c){r.push(c);continue}let d=l?.find(f=>f.playerId===a&&f.predicted);if(d){r.push(d);continue}let u=dr(i,e,a);r.push(u),gt(i,u)}return r}function dr(i,e,t){let{inputBuffer:n}=i,o=null;for(let s=e-1;s>=Math.max(0,e-60);s--){let l=n.inputs.get(s)?.find(c=>c.playerId===t&&!c.predicted);if(l){o=l;break}}let r=o?{...o.data}:{w:!1,a:!1,s:!1,d:!1,jump:!1,yawFp:0};return{frame:e,playerId:t,data:r,predicted:!0}}function un(i){let{currentFrame:e,config:t,snapshots:n}=i;if(e%t.snapshotInterval!==0)return;let o={frame:e,state:i.saveState()};n.set(e,o);let r=e-t.maxRollbackFrames-10;for(let s of n.keys())s<r&&n.delete(s)}function Bn(i,e){let t=i.snapshots.get(e);return t?(i.loadState(t.state),!0):!1}function Rn(i){let{currentFrame:e,config:t}=i,n=i.pendingRollbackFrame;return n!==void 0&&(i.pendingRollbackFrame=void 0,e-n<=t.maxRollbackFrames)?n:null}function An(i,e){let{currentFrame:t}=i,n=e;for(;n>=0&&!i.snapshots.has(n);)n--;if(n<0||!Bn(i,n))return;i.rollbackCount++;let o=t-n;o>i.maxRollbackDepth&&(i.maxRollbackDepth=o);for(let r=n;r<t;r++){i.currentFrame=r,un(i);let s=pn(i,r);i.tick(r,s),i.currentFrame=r+1}}function po(i){let e=!1,t=Rn(i);t!==null&&t<i.currentFrame&&(An(i,t),e=!0),un(i);let n=pn(i,i.currentFrame);return i.tick(i.currentFrame,n),i.currentFrame++,pr(i),ur(i),{inputs:n,didRollback:e}}function pr(i){let{inputBuffer:e,players:t,currentFrame:n,config:o}=i,r=Math.max(e.lastConfirmedFrame+1,o.inputDelay),s=Array.from(t).sort();for(let a=r;a<n;a++){let l=e.inputs.get(a);if(!l)break;let c=!0;for(let d of s)if(!l.find(f=>f.playerId===d&&!f.predicted)){c=!1;break}if(c)e.lastConfirmedFrame=a;else break}}function ur(i){let{inputBuffer:e,config:t,currentFrame:n}=i,o=n-t.maxRollbackFrames-10;for(let r of e.inputs.keys())r<o&&e.inputs.delete(r)}function uo(i){let e=i.localInputQueue.filter(t=>t.frame<=i.currentFrame+i.config.inputDelay);return i.localInputQueue=i.localInputQueue.filter(t=>t.frame>i.currentFrame+i.config.inputDelay),e}function fo(i){return{frame:i.currentFrame,checksum:i.computeChecksum()}}function ho(i){return{currentFrame:i.currentFrame,confirmedFrame:i.inputBuffer.lastConfirmedFrame,rollbackCount:i.rollbackCount,maxRollbackDepth:i.maxRollbackDepth,predictionMisses:i.predictionMisses,snapshotCount:i.snapshots.size,inputBufferSize:i.inputBuffer.inputs.size}}return vo(fr);})();
